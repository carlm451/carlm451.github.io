<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Message Passing on <strong>Graphs</strong> — Topological Deep Learning Course</title>
<script>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']]},svg:{fontCache:'global'}};</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-svg-full.min.js"></script>
<link rel="stylesheet" href="../assets/style.css">
</head>
<body class="page-chapter">
<header>
  <div class="container">
    <div class="breadcrumb"><a href="../index.html">Home</a> / <a href="tdl-index.html">Topological Deep Learning</a> / Chapter 2</div>
    <span class="ch-num">Chapter 02</span>
    <h1>Message Passing on <strong>Graphs</strong></h1>
    <p class="subtitle">From feedforward networks to graph neural networks — the GCN layer deconstructed with a full numerical walkthrough on our running example.</p>
  </div>
</header>
<nav class="ch-nav"><div class="container"><a href="tdl-01-graphs.html">← Graphs as Combinatorial Objects</a><span class="ch-title">Chapter 2</span><a href="tdl-03-edge-signals.html">Edge Signals & the Discrete Curl →</a></div></nav>
<div class="progress-bar"><div class="progress-fill"></div></div>
<main class="container" style="padding-top:2rem;padding-bottom:2rem;">

<!-- Table of Contents -->
<div class="toc">
  <div class="toc-label">In this chapter</div>
  <ol>
    <li><a href="#sec3"><span class="toc-num">03</span>Quick Review: Feedforward Neural Networks</a></li>
    <li><a href="#sec4"><span class="toc-num">04</span>From Feedforward to Graph</a></li>
    <li><a href="#sec5"><span class="toc-num">05</span>Building the Normalized Adjacency</a></li>
    <li><a href="#sec6"><span class="toc-num">06</span>Full Numerical Walkthrough</a></li>
    <li><a href="#sec7"><span class="toc-num">07</span>Stacking Layers and the Receptive Field</a></li>
    <li><a href="#sec8"><span class="toc-num">08</span>The GCN-Laplacian Connection</a></li>
  </ol>
</div>

<section id="sec3">
  <h2><span class="sec-num">03</span>Quick Review: Feedforward Neural Networks</h2>

  <p>
    Before diving into GNNs, let's recall the simplest neural network architecture — the <strong>feedforward network</strong> (multilayer perceptron). If this is already familiar, skim through; the purpose is to establish the notation and identify exactly what changes when we move to graphs.
  </p>

  <div class="def-box">
    <div class="def-label">A Single Feedforward Layer</div>
    <p>Given an input vector $\mathbf{x} \in \mathbb{R}^{d_{\text{in}}}$, one layer computes:</p>
    $$\mathbf{y} = \sigma(\mathbf{W}\mathbf{x} + \mathbf{b})$$
    <p>where $\mathbf{W} \in \mathbb{R}^{d_{\text{out}} \times d_{\text{in}}}$ is a learnable <strong>weight matrix</strong>, $\mathbf{b} \in \mathbb{R}^{d_{\text{out}}}$ is a learnable <strong>bias</strong>, and $\sigma$ is a nonlinear <strong>activation function</strong> (ReLU, tanh, etc.).</p>
  </div>

  <div class="figure">
    <svg viewBox="0 0 660 230" width="660" height="230">
      <text x="330" y="22" font-family="Source Sans 3" font-size="14" font-weight="700" fill="#2a2520" text-anchor="middle">A Feedforward Layer: Wx + b → σ</text>

      <!-- Input -->
      <text x="60" y="52" font-family="Source Sans 3" font-size="11" font-weight="600" fill="#b44a2f" text-anchor="middle">Input x</text>
      <circle cx="60" cy="80" r="14" fill="#e8a88a" stroke="#b44a2f" stroke-width="2"/>
      <text x="60" y="85" fill="white" font-family="JetBrains Mono" font-size="10" text-anchor="middle" font-weight="500">x₁</text>
      <circle cx="60" cy="130" r="14" fill="#e8a88a" stroke="#b44a2f" stroke-width="2"/>
      <text x="60" y="135" fill="white" font-family="JetBrains Mono" font-size="10" text-anchor="middle" font-weight="500">x₂</text>
      <circle cx="60" cy="180" r="14" fill="#e8a88a" stroke="#b44a2f" stroke-width="2"/>
      <text x="60" y="185" fill="white" font-family="JetBrains Mono" font-size="10" text-anchor="middle" font-weight="500">x₃</text>

      <!-- Weights -->
      <line x1="74" y1="80" x2="186" y2="95" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="74" y1="80" x2="186" y2="145" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="74" y1="130" x2="186" y2="95" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="74" y1="130" x2="186" y2="145" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="74" y1="180" x2="186" y2="95" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="74" y1="180" x2="186" y2="145" stroke="#d5d0c8" stroke-width="1"/>

      <text x="130" y="72" font-family="Source Sans 3" font-size="10" fill="#6b6560" text-anchor="middle" font-style="italic">W (weights)</text>

      <!-- Summation -->
      <text x="200" y="52" font-family="Source Sans 3" font-size="11" font-weight="600" fill="#3a5a8c" text-anchor="middle">Σ + b</text>
      <circle cx="200" cy="95" r="14" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="2"/>
      <text x="200" y="100" fill="white" font-family="JetBrains Mono" font-size="10" text-anchor="middle">Σ</text>
      <circle cx="200" cy="145" r="14" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="2"/>
      <text x="200" y="150" fill="white" font-family="JetBrains Mono" font-size="10" text-anchor="middle">Σ</text>

      <!-- Activation -->
      <line x1="214" y1="95" x2="276" y2="95" stroke="#6b6560" stroke-width="1.5"/>
      <line x1="214" y1="145" x2="276" y2="145" stroke="#6b6560" stroke-width="1.5"/>
      <text x="245" y="82" font-family="Source Sans 3" font-size="10" fill="#6b6560" text-anchor="middle">σ(·)</text>

      <rect x="276" y="80" width="50" height="30" rx="5" fill="#2a6b5a" fill-opacity="0.15" stroke="#2a6b5a" stroke-width="1.5"/>
      <text x="301" y="100" font-family="Source Sans 3" font-size="10" fill="#2a6b5a" text-anchor="middle" font-weight="600">ReLU</text>
      <rect x="276" y="130" width="50" height="30" rx="5" fill="#2a6b5a" fill-opacity="0.15" stroke="#2a6b5a" stroke-width="1.5"/>
      <text x="301" y="150" font-family="Source Sans 3" font-size="10" fill="#2a6b5a" text-anchor="middle" font-weight="600">ReLU</text>

      <!-- Output -->
      <line x1="326" y1="95" x2="376" y2="95" stroke="#6b6560" stroke-width="1.5"/>
      <line x1="326" y1="145" x2="376" y2="145" stroke="#6b6560" stroke-width="1.5"/>
      <circle cx="390" cy="95" r="14" fill="#8ec5b6" stroke="#2a6b5a" stroke-width="2"/>
      <text x="390" y="100" fill="white" font-family="JetBrains Mono" font-size="10" text-anchor="middle" font-weight="500">y₁</text>
      <circle cx="390" cy="145" r="14" fill="#8ec5b6" stroke="#2a6b5a" stroke-width="2"/>
      <text x="390" y="150" fill="white" font-family="JetBrains Mono" font-size="10" text-anchor="middle" font-weight="500">y₂</text>
      <text x="390" y="52" font-family="Source Sans 3" font-size="11" font-weight="600" fill="#2a6b5a" text-anchor="middle">Output y</text>

      <!-- Key insight box -->
      <rect x="440" y="60" width="200" height="145" rx="8" fill="#f8f4ee" stroke="#d5d0c8"/>
      <text x="455" y="82" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#2a2520">The key ingredients:</text>
      <text x="455" y="104" font-family="Source Sans 3" font-size="10.5" fill="#2a2520">1. Linear transform (W, b)</text>
      <text x="455" y="120" font-family="Source Sans 3" font-size="10.5" fill="#2a2520">2. Nonlinearity (σ)</text>
      <text x="455" y="145" font-family="Source Sans 3" font-size="10.5" fill="#b44a2f" font-weight="600">What's missing?</text>
      <text x="455" y="163" font-family="Source Sans 3" font-size="10.5" fill="#2a2520">Each input is processed</text>
      <text x="455" y="179" font-family="Source Sans 3" font-size="10.5" fill="#2a2520">independently. There's no</text>
      <text x="455" y="195" font-family="Source Sans 3" font-size="10.5" fill="#b44a2f" font-weight="600">communication between nodes.</text>
    </svg>
    <div class="caption"><strong>Figure 3.1.</strong> A single feedforward layer transforms each input independently: linear map + nonlinearity. If we applied this to each vertex of a graph, vertex 0 would have no idea what vertex 1's features look like. A GNN adds exactly one ingredient: <em>aggregation from neighbors</em>.</div>
  </div>

  <p>
    The critical observation: a feedforward network applied to graph vertices would process each vertex in isolation. Vertex $v_0$ at 50°C would have no idea that its neighbor $v_1$ is at 20°C. This is useless for tasks like heat conduction or social influence — where the whole point is that <em>neighbors affect each other</em>.
  </p>
</section>

<hr class="divider">

<section id="sec4">
  <h2><span class="sec-num">04</span>From Feedforward to Graph: Adding Neighborhood Aggregation</h2>

  <p>
    A graph neural network adds one fundamental operation before the linear transform: <strong>aggregate features from neighbors</strong>. Here is the general message passing framework:
  </p>

  <div class="def-box green">
    <div class="def-label">GNN Message Passing — One Layer (General Form)</div>
    $$\mathbf{h}_v^{(\ell+1)} = \phi\!\left(\mathbf{h}_v^{(\ell)},\; \bigoplus_{w \in \mathcal{N}(v)} \psi\!\left(\mathbf{h}_v^{(\ell)}, \mathbf{h}_w^{(\ell)}\right)\right)$$
    <p>Three components:</p>
    <p style="margin-left:1.5rem;">
      $\psi$ = <strong>message function</strong>: computes a "message" from neighbor $w$ to node $v$<br>
      $\bigoplus$ = <strong>aggregation</strong>: combines all incoming messages (sum, mean, max, ...)<br>
      $\phi$ = <strong>update function</strong>: combines old features with aggregated messages to produce new features
    </p>
  </div>

  <p>
    This looks abstract, so let's see the most concrete and widely-used instantiation: the <strong>Graph Convolutional Network</strong> (GCN) of Kipf &amp; Welling (2017).
  </p>

  <h3>The GCN Layer — Making it Concrete</h3>

  <p>
    In a GCN, the message, aggregation, and update functions are collapsed into a single elegant matrix operation:
  </p>

  <div class="def-box">
    <div class="def-label">GCN Layer (Kipf &amp; Welling, 2017)</div>
    $$\mathbf{H}^{(\ell+1)} = \sigma\!\left(\hat{\mathbf{A}} \, \mathbf{H}^{(\ell)} \, \mathbf{W}^{(\ell)}\right)$$
    <p>where:</p>
    <p style="margin-left:1.5rem;">
      $\mathbf{H}^{(\ell)} \in \mathbb{R}^{n \times d_\ell}$ = feature matrix (row $v$ = feature vector of vertex $v$ at layer $\ell$)<br>
      $\mathbf{W}^{(\ell)} \in \mathbb{R}^{d_\ell \times d_{\ell+1}}$ = learnable weight matrix (shared across all vertices)<br>
      $\hat{\mathbf{A}} = \tilde{\mathbf{D}}^{-1/2} \tilde{\mathbf{A}} \tilde{\mathbf{D}}^{-1/2}$ = normalized adjacency with self-loops<br>
      $\tilde{\mathbf{A}} = \mathbf{A} + \mathbf{I}$ = adjacency + self-loops, &ensp; $\tilde{\mathbf{D}}_{ii} = \sum_j \tilde{A}_{ij}$<br>
      $\sigma$ = activation function (typically ReLU)
    </p>
  </div>

  <div class="insight key">
    <p><strong>Connecting to feedforward intuition:</strong> Think of the feature matrix $\mathbf{H}$ as a batch of $n$ samples, one per vertex. Without any graph structure ($\mathbf{A} = 0$, so $\hat{\mathbf{A}} = \mathbf{I}$), the GCN equation reduces to $\sigma(\mathbf{I} \cdot \mathbf{H} \cdot \mathbf{W}) = \sigma(\mathbf{H}\mathbf{W})$ — each row of $\mathbf{H}$ gets multiplied by $\mathbf{W}$ independently. That's just a standard feedforward layer applied to each vertex as if it were a separate sample in a batch. No vertex knows any other vertex exists.</p>
    <p>Now add edges. The matrix $\hat{\mathbf{A}}$ is no longer the identity — it has off-diagonal entries wherever edges exist. Multiplying $\hat{\mathbf{A}}\mathbf{H}$ <em>mixes the rows</em> of $\mathbf{H}$ together before the linear transform. It's as if the samples in your batch started talking to each other: "Hey, I'm at 50°C, what about you?" The graph structure determines <em>who talks to whom</em>, and the normalization determines <em>how much each neighbor's voice counts</em>.</p>
    <p>In short: <strong>a GCN is a feedforward network where the batch samples are allowed to exchange information along edges before each layer.</strong></p>
  </div>

  <div class="insight physics">
    <p><strong>The other extreme — a fully connected graph:</strong> What if <em>every</em> node is connected to every other? All degrees equal $n$, so the symmetric normalization gives $\hat{A}_{ij} = 1/n$ for every entry. Now $\hat{\mathbf{A}}\mathbf{H}$ replaces each vertex's features with the <strong>uniform average</strong> over all vertices. Every vertex gets the same aggregated representation — all local structure is erased.</p>
    <p>Physicists will recognize this as the <strong>mean field approximation</strong>. In the Ising model, each spin interacts with specific neighbors through the lattice. Mean field theory replaces those local interactions with a single effective field: the average over all spins. This is mathematically equivalent to putting the system on a fully connected graph — every spin talks to every other spin equally. The approximation becomes exact in the limit of infinite neighbors (infinite dimensions), precisely because the true local field converges to the global average.</p>
    <p>This gives us three regimes to reason about what $\hat{\mathbf{A}}$ does:</p>
    <p style="margin-left:1.5rem;">
      <strong>No edges</strong> ($\hat{\mathbf{A}} = \mathbf{I}$): independent particles — each vertex ignores all others<br>
      <strong>Sparse graph</strong> ($\hat{\mathbf{A}}$ has structure): real interactions — local neighborhood determines each vertex's update<br>
      <strong>Fully connected</strong> ($\hat{\mathbf{A}} = \tfrac{1}{n}\mathbf{1}\mathbf{1}^\top$): mean field — every vertex sees the same global average, local structure is lost
    </p>
    <p>The power of GNNs lies in the middle regime: the graph encodes <em>which</em> interactions matter, preserving local structure that mean field theory deliberately throws away.</p>
  </div>

  <p>
    Let's unpack what each piece does. Reading the equation <strong>left to right</strong>:
  </p>

  <div class="figure">
    <svg viewBox="0 0 680 180" width="680" height="180">
      <text x="340" y="22" font-family="Source Sans 3" font-size="14" font-weight="700" fill="#2a2520" text-anchor="middle">Reading the GCN Equation: σ( Â · H · W )</text>

      <!-- Step 1: ÂH -->
      <rect x="20" y="45" width="195" height="120" rx="8" fill="white" stroke="#2a6b5a" stroke-width="1.5"/>
      <text x="117" y="68" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#2a6b5a" text-anchor="middle">① Â · H</text>
      <text x="35" y="90" font-family="Source Sans 3" font-size="10.5" fill="#2a2520">Mix each vertex with its</text>
      <text x="35" y="106" font-family="Source Sans 3" font-size="10.5" fill="#2a2520">neighbors via normalized</text>
      <text x="35" y="122" font-family="Source Sans 3" font-size="10.5" fill="#2a2520">weighted average</text>
      <text x="35" y="146" font-family="Source Sans 3" font-size="10.5" fill="#2a6b5a" font-weight="600" font-style="italic">This is the graph part!</text>
      <text x="35" y="158" font-family="JetBrains Mono" font-size="9" fill="#2a6b5a">structure-aware aggregation</text>

      <!-- Step 2: (ÂH) · W -->
      <rect x="240" y="45" width="195" height="120" rx="8" fill="white" stroke="#b44a2f" stroke-width="1.5"/>
      <text x="337" y="68" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#b44a2f" text-anchor="middle">② (result) · W</text>
      <text x="255" y="90" font-family="Source Sans 3" font-size="10.5" fill="#2a2520">Transform each vertex's</text>
      <text x="255" y="106" font-family="Source Sans 3" font-size="10.5" fill="#2a2520">aggregated features</text>
      <text x="255" y="126" font-family="Source Sans 3" font-size="10.5" fill="#6b6560" font-style="italic">Same as feedforward:</text>
      <text x="255" y="142" font-family="Source Sans 3" font-size="10.5" fill="#6b6560" font-style="italic">linear map per vertex</text>
      <text x="255" y="158" font-family="JetBrains Mono" font-size="9" fill="#b44a2f">d_in → d_out features</text>

      <!-- Step 3: σ -->
      <rect x="460" y="45" width="195" height="120" rx="8" fill="white" stroke="#3a5a8c" stroke-width="1.5"/>
      <text x="557" y="68" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#3a5a8c" text-anchor="middle">③ σ(·)</text>
      <text x="475" y="90" font-family="Source Sans 3" font-size="10.5" fill="#2a2520">Apply nonlinearity</text>
      <text x="475" y="106" font-family="Source Sans 3" font-size="10.5" fill="#2a2520">(ReLU: keep positives,</text>
      <text x="475" y="122" font-family="Source Sans 3" font-size="10.5" fill="#2a2520">zero out negatives)</text>
      <text x="475" y="146" font-family="Source Sans 3" font-size="10.5" fill="#6b6560" font-style="italic">Same as feedforward:</text>
      <text x="475" y="158" font-family="JetBrains Mono" font-size="9" fill="#3a5a8c">element-wise activation</text>
    </svg>
    <div class="caption"><strong>Figure 4.1.</strong> The three steps of a GCN layer. Step ① is the <em>only</em> step that uses the graph structure — it mixes each vertex's features with its neighbors'. Step ② is a standard feedforward transform (same weights for every vertex). Step ③ is a standard nonlinearity. Note: because matrix multiplication is associative, $\hat{\mathbf{A}}(\mathbf{H}\mathbf{W}) = (\hat{\mathbf{A}}\mathbf{H})\mathbf{W}$ — you could equally transform first and aggregate second with the same result. The aggregate-first order shown here is the standard convention.</div>
  </div>
</section>

<hr class="divider">

<section id="sec5">
  <h2><span class="sec-num">05</span>Building $\hat{\mathbf{A}}$: The Normalized Adjacency</h2>

  <p>
    Before we can run a GCN layer, we need to construct $\hat{\mathbf{A}}$. Let's build it step by step for our Figure 2.1 graph.
  </p>

  <h3>Step 1: Add Self-Loops</h3>

  <p>
    Without self-loops, the aggregation would only look at <em>neighbors</em>, forgetting the vertex's own features. Adding $\mathbf{I}$ ensures each vertex also "sends a message to itself":
  </p>

  <div class="figure">
    <svg viewBox="0 0 650 155" width="650" height="155">
      <text x="100" y="22" font-family="Source Sans 3" font-size="12" font-weight="700" fill="#2a2520" text-anchor="middle">A (adjacency)</text>
      <text x="50" y="50" font-family="JetBrains Mono" font-size="11" fill="#2a2520">[<tspan fill="#b0a89e">0</tspan> 1 1 1]</text>
      <text x="50" y="68" font-family="JetBrains Mono" font-size="11" fill="#2a2520">[1 <tspan fill="#b0a89e">0</tspan> 1 0]</text>
      <text x="50" y="86" font-family="JetBrains Mono" font-size="11" fill="#2a2520">[1 1 <tspan fill="#b0a89e">0</tspan> 1]</text>
      <text x="50" y="104" font-family="JetBrains Mono" font-size="11" fill="#2a2520">[1 0 1 <tspan fill="#b0a89e">0</tspan>]</text>

      <text x="230" y="75" font-family="Source Sans 3" font-size="20" fill="#6b6560">+</text>

      <text x="310" y="22" font-family="Source Sans 3" font-size="12" font-weight="700" fill="#2a2520" text-anchor="middle">I (identity)</text>
      <text x="265" y="50" font-family="JetBrains Mono" font-size="11" fill="#2a6b5a">[<tspan font-weight="600">1</tspan> 0 0 0]</text>
      <text x="265" y="68" font-family="JetBrains Mono" font-size="11" fill="#2a6b5a">[0 <tspan font-weight="600">1</tspan> 0 0]</text>
      <text x="265" y="86" font-family="JetBrains Mono" font-size="11" fill="#2a6b5a">[0 0 <tspan font-weight="600">1</tspan> 0]</text>
      <text x="265" y="104" font-family="JetBrains Mono" font-size="11" fill="#2a6b5a">[0 0 0 <tspan font-weight="600">1</tspan>]</text>

      <text x="435" y="75" font-family="Source Sans 3" font-size="20" fill="#6b6560">=</text>

      <text x="560" y="22" font-family="Source Sans 3" font-size="12" font-weight="700" fill="#b44a2f" text-anchor="middle">Ã = A + I</text>
      <text x="490" y="50" font-family="JetBrains Mono" font-size="11" fill="#2a2520">[<tspan fill="#b44a2f" font-weight="600">1</tspan> 1 1 1]</text>
      <text x="490" y="68" font-family="JetBrains Mono" font-size="11" fill="#2a2520">[1 <tspan fill="#b44a2f" font-weight="600">1</tspan> 1 0]</text>
      <text x="490" y="86" font-family="JetBrains Mono" font-size="11" fill="#2a2520">[1 1 <tspan fill="#b44a2f" font-weight="600">1</tspan> 1]</text>
      <text x="490" y="104" font-family="JetBrains Mono" font-size="11" fill="#2a2520">[1 0 1 <tspan fill="#b44a2f" font-weight="600">1</tspan>]</text>

      <text x="490" y="135" font-family="Source Sans 3" font-size="10" fill="#6b6560">Row sums → d̃: [4, 3, 4, 3]</text>
      <text x="490" y="150" font-family="Source Sans 3" font-size="10" fill="#6b6560">(original degree + 1 for self-loop)</text>
    </svg>
    <div class="caption"><strong>Figure 5.1.</strong> Adding self-loops. The diagonal of $\mathbf{A}$ was zero (a vertex isn't its own neighbor); adding $\mathbf{I}$ puts 1s on the diagonal. Now each row sums to $\deg(v) + 1$.</div>
  </div>

  <h3>Step 2: Symmetric Normalization</h3>

  <p>
    Without normalization, high-degree vertices would dominate (they sum more neighbors). The symmetric normalization $\hat{\mathbf{A}} = \tilde{\mathbf{D}}^{-1/2}\tilde{\mathbf{A}}\tilde{\mathbf{D}}^{-1/2}$ produces a <em>weighted average</em> where each edge is downweighted by both endpoint degrees:
  </p>

  <div class="math-block">
    <div class="math-label">Normalization coefficient</div>
    $$\hat{A}_{ij} = \frac{\tilde{A}_{ij}}{\sqrt{\tilde{d}_i}\sqrt{\tilde{d}_j}}$$
  </div>

  <div class="insight">
    <p><strong>What does $\mathbf{D}^{-1/2}$ actually mean?</strong> This notation looks intimidating, but for a <strong>diagonal</strong> matrix it's trivial. A diagonal matrix $\mathbf{D}$ only has nonzero entries on the diagonal: $D_{ii} = d_i$. Every matrix operation reduces to a scalar operation on each diagonal entry independently:</p>
    <p style="margin-left:1.5rem;">
      $\mathbf{D}^{1/2}$: take the square root → $D^{1/2}_{ii} = \sqrt{d_i}$<br>
      $\mathbf{D}^{-1}$: take the reciprocal → $D^{-1}_{ii} = 1/d_i$<br>
      $\mathbf{D}^{-1/2}$: combine both → $D^{-1/2}_{ii} = 1/\sqrt{d_i}$
    </p>
    <p>For our graph with $\tilde{d} = (4, 3, 4, 3)$:</p>
    <p style="margin-left:1.5rem;">
      $\tilde{\mathbf{D}}^{-1/2} = \text{diag}\!\left(\frac{1}{\sqrt{4}},\; \frac{1}{\sqrt{3}},\; \frac{1}{\sqrt{4}},\; \frac{1}{\sqrt{3}}\right) = \text{diag}(0.500,\; 0.577,\; 0.500,\; 0.577)$
    </p>
    <p>This only works because $\mathbf{D}$ is diagonal. For a general matrix, $\mathbf{M}^{-1/2}$ requires eigendecomposition — but degree matrices are always diagonal, so we never need that here.</p>
  </div>

  <div class="figure">
    <svg viewBox="0 0 650 210" width="650" height="210">
      <text x="325" y="22" font-family="Source Sans 3" font-size="14" font-weight="700" fill="#2a2520" text-anchor="middle">Building Â for Our Graph</text>

      <rect x="20" y="42" width="610" height="155" rx="8" fill="#f8f4ee" stroke="#d5d0c8"/>
      <text x="35" y="68" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#2a2520">Normalization coefficients: Â(i,j) = 1 / (√d̃ᵢ · √d̃ⱼ)  when Ã(i,j) = 1</text>

      <text x="35" y="100" font-family="JetBrains Mono" font-size="11" fill="#2a2520">Â(0,0) = 1/(√4·√4) = 1/4  = <tspan fill="#b44a2f" font-weight="600">0.250</tspan>  (self)</text>
      <text x="35" y="118" font-family="JetBrains Mono" font-size="11" fill="#2a2520">Â(0,1) = 1/(√4·√3) = 1/2√3 = <tspan fill="#b44a2f" font-weight="600">0.289</tspan>  (v0↔v1)</text>
      <text x="35" y="136" font-family="JetBrains Mono" font-size="11" fill="#2a2520">Â(0,2) = 1/(√4·√4) = 1/4  = <tspan fill="#b44a2f" font-weight="600">0.250</tspan>  (v0↔v2)</text>
      <text x="35" y="154" font-family="JetBrains Mono" font-size="11" fill="#2a2520">Â(0,3) = 1/(√4·√3) = 1/2√3 = <tspan fill="#b44a2f" font-weight="600">0.289</tspan>  (v0↔v3)</text>
      <text x="35" y="178" font-family="Source Sans 3" font-size="11" fill="#6b6560">Row sum for v0: 0.250 + 0.289 + 0.250 + 0.289 = 1.077 ≈ 1 (approximate average)</text>

      <!-- Matrix -->
      <text x="430" y="100" font-family="JetBrains Mono" font-size="11" fill="#6b6560">        v0    v1    v2    v3</text>
      <text x="420" y="118" font-family="JetBrains Mono" font-size="11" fill="#2a2520">v0 [.250 .289 .250 .289]</text>
      <text x="420" y="136" font-family="JetBrains Mono" font-size="11" fill="#2a2520">v1 [.289 .333 .289  0  ]</text>
      <text x="420" y="154" font-family="JetBrains Mono" font-size="11" fill="#2a2520">v2 [.250 .289 .250 .289]</text>
      <text x="420" y="172" font-family="JetBrains Mono" font-size="11" fill="#2a2520">v3 [.289  0   .289 .333]</text>
    </svg>
    <div class="caption"><strong>Figure 5.2.</strong> The normalized adjacency matrix $\hat{\mathbf{A}}$. Each entry is $1/\sqrt{\tilde{d}_i \tilde{d}_j}$ where a connection exists, 0 otherwise. Row sums are approximately 1, so $\hat{\mathbf{A}}$ acts as a soft averaging operator. The degree-3 vertices (v1, v3) get slightly higher self-weight (0.333 vs 0.250) because they have fewer neighbors to dilute over.</div>
  </div>

  <div class="insight">
    <p><strong>Why symmetric?</strong> Left-multiplying by $\tilde{\mathbf{D}}^{-1}$ alone (i.e., simple row-normalization) would give an exact row-stochastic average, but it breaks the symmetry of the operator. The symmetric form $\tilde{\mathbf{D}}^{-1/2}\tilde{\mathbf{A}}\tilde{\mathbf{D}}^{-1/2}$ keeps $\hat{\mathbf{A}}$ symmetric, which preserves the spectral theory from Chapter 1 — the eigenvalues are real, the eigenvectors are orthogonal, and the connection to the Laplacian ($\mathbf{L}_0 = \mathbf{I} - \hat{\mathbf{A}}_{\text{(without self-loops)}}$) is maintained.</p>
  </div>
</section>

<hr class="divider">

<section id="sec6">
  <h2><span class="sec-num">06</span>Full Numerical Walkthrough: One GCN Layer</h2>

  <p>
    Now let's run a complete GCN layer on our graph, tracking every number. We'll use 2-dimensional input features (for readability) and map to 3-dimensional outputs.
  </p>

  <h3>Setup: Initial Features</h3>

  <p>Assign each vertex a 2D feature vector — think of these as (normalized temperature, thermal conductivity):</p>

  <div class="figure">
    <svg viewBox="0 0 650 200" width="650" height="200">
      <text x="325" y="22" font-family="Source Sans 3" font-size="14" font-weight="700" fill="#2a2520" text-anchor="middle">Initial Vertex Features H⁰ ∈ ℝ⁴ˣ²</text>

      <!-- Graph with features -->
      <line x1="90" y1="100" x2="200" y2="65" stroke="#d5d0c8" stroke-width="2"/>
      <line x1="90" y1="100" x2="200" y2="150" stroke="#d5d0c8" stroke-width="2"/>
      <line x1="200" y1="65" x2="200" y2="150" stroke="#d5d0c8" stroke-width="2"/>
      <line x1="90" y1="100" x2="130" y2="180" stroke="#d5d0c8" stroke-width="2"/>
      <line x1="200" y1="150" x2="130" y2="180" stroke="#d5d0c8" stroke-width="2"/>

      <circle cx="90" cy="100" r="16" fill="#e8a88a" stroke="#b44a2f" stroke-width="2"/>
      <text x="90" y="105" fill="white" font-family="Source Sans 3" font-size="11" text-anchor="middle" font-weight="600">0</text>
      <circle cx="200" cy="65" r="16" fill="#e8a88a" stroke="#b44a2f" stroke-width="2"/>
      <text x="200" y="70" fill="white" font-family="Source Sans 3" font-size="11" text-anchor="middle" font-weight="600">1</text>
      <circle cx="200" cy="150" r="16" fill="#e8a88a" stroke="#b44a2f" stroke-width="2"/>
      <text x="200" y="155" fill="white" font-family="Source Sans 3" font-size="11" text-anchor="middle" font-weight="600">2</text>
      <circle cx="130" cy="180" r="16" fill="#e8a88a" stroke="#b44a2f" stroke-width="2"/>
      <text x="130" y="185" fill="white" font-family="Source Sans 3" font-size="11" text-anchor="middle" font-weight="600">3</text>

      <!-- Feature labels -->
      <rect x="38" y="72" width="40" height="14" rx="3" fill="#b44a2f"/>
      <text x="58" y="83" font-family="JetBrains Mono" font-size="8" fill="white" text-anchor="middle">1.0, 0.2</text>
      <rect x="218" y="52" width="40" height="14" rx="3" fill="#2a6b5a"/>
      <text x="238" y="63" font-family="JetBrains Mono" font-size="8" fill="white" text-anchor="middle">0.4, 0.8</text>
      <rect x="218" y="143" width="40" height="14" rx="3" fill="#3a5a8c"/>
      <text x="238" y="154" font-family="JetBrains Mono" font-size="8" fill="white" text-anchor="middle">0.7, 0.3</text>
      <rect x="142" y="186" width="40" height="14" rx="3" fill="#8b5a8c"/>
      <text x="162" y="197" font-family="JetBrains Mono" font-size="8" fill="white" text-anchor="middle">0.2, 0.9</text>

      <!-- Matrix form -->
      <rect x="320" y="40" width="310" height="150" rx="8" fill="white" stroke="#d5d0c8"/>
      <text x="475" y="65" font-family="Source Sans 3" font-size="12" font-weight="700" fill="#2a2520" text-anchor="middle">Feature matrix H⁰</text>

      <text x="415" y="90" font-family="JetBrains Mono" font-size="10" fill="#6b6560">      f₁    f₂</text>
      <text x="400" y="110" font-family="JetBrains Mono" font-size="12" fill="#b44a2f">v₀  [1.0   0.2]</text>
      <text x="400" y="128" font-family="JetBrains Mono" font-size="12" fill="#2a6b5a">v₁  [0.4   0.8]</text>
      <text x="400" y="146" font-family="JetBrains Mono" font-size="12" fill="#3a5a8c">v₂  [0.7   0.3]</text>
      <text x="400" y="164" font-family="JetBrains Mono" font-size="12" fill="#8b5a8c">v₃  [0.2   0.9]</text>
    </svg>
    <div class="caption"><strong>Figure 6.1.</strong> The initial features. Each vertex carries a 2D vector. The feature matrix $\mathbf{H}^{(0)}$ stacks all vertex features into a $4 \times 2$ matrix.</div>
  </div>

  <h3>Step 1: Aggregate — $\hat{\mathbf{A}} \cdot \mathbf{H}^{(0)}$</h3>

  <p>
    Multiplying $\hat{\mathbf{A}} \cdot \mathbf{H}^{(0)}$ computes a <strong>normalized weighted average</strong> of each vertex's own features and its neighbors' features. Let's trace vertex $v_0$ in full detail:
  </p>

  <div class="figure">
    <svg viewBox="0 0 680 340" width="680" height="340">
      <text x="340" y="22" font-family="Source Sans 3" font-size="14" font-weight="700" fill="#2a2520" text-anchor="middle">Detailed: Computing the Aggregated Feature for v₀</text>

      <!-- Graph highlighting v0's neighborhood -->
      <line x1="70" y1="95" x2="160" y2="65" stroke="#b44a2f" stroke-width="2.5"/>
      <line x1="70" y1="95" x2="160" y2="140" stroke="#b44a2f" stroke-width="2.5"/>
      <line x1="160" y1="65" x2="160" y2="140" stroke="#d5d0c8" stroke-width="1.5"/>
      <line x1="70" y1="95" x2="100" y2="170" stroke="#b44a2f" stroke-width="2.5"/>
      <line x1="160" y1="140" x2="100" y2="170" stroke="#d5d0c8" stroke-width="1.5"/>

      <circle cx="70" cy="95" r="18" fill="#b44a2f" stroke="#8a2a1a" stroke-width="2.5"/>
      <text x="70" y="100" fill="white" font-family="Source Sans 3" font-size="12" text-anchor="middle" font-weight="700">0</text>
      <circle cx="160" cy="65" r="14" fill="#e8a88a" stroke="#b44a2f" stroke-width="1.5"/>
      <text x="160" y="70" fill="white" font-family="Source Sans 3" font-size="10" text-anchor="middle">1</text>
      <circle cx="160" cy="140" r="14" fill="#e8a88a" stroke="#b44a2f" stroke-width="1.5"/>
      <text x="160" y="145" fill="white" font-family="Source Sans 3" font-size="10" text-anchor="middle">2</text>
      <circle cx="100" cy="170" r="14" fill="#e8a88a" stroke="#b44a2f" stroke-width="1.5"/>
      <text x="100" y="175" fill="white" font-family="Source Sans 3" font-size="10" text-anchor="middle">3</text>

      <text x="110" y="210" font-family="Source Sans 3" font-size="10" fill="#b44a2f" text-anchor="middle" font-weight="600">v₀ receives from all</text>
      <text x="110" y="224" font-family="Source Sans 3" font-size="10" fill="#b44a2f" text-anchor="middle" font-weight="600">3 neighbors + itself</text>

      <!-- Computation -->
      <rect x="220" y="40" width="440" height="280" rx="8" fill="white" stroke="#b44a2f" stroke-width="1.5"/>
      <text x="440" y="65" font-family="Source Sans 3" font-size="12" font-weight="700" fill="#b44a2f" text-anchor="middle">Aggregated feature for v₀ = Row 0 of Â · H⁰</text>

      <text x="240" y="92" font-family="JetBrains Mono" font-size="11" fill="#2a2520">ĥ(v₀) = <tspan fill="#b44a2f" font-weight="600">0.250</tspan>·h(v₀) + <tspan fill="#2a6b5a" font-weight="600">0.289</tspan>·h(v₁) + <tspan fill="#3a5a8c" font-weight="600">0.250</tspan>·h(v₂) + <tspan fill="#8b5a8c" font-weight="600">0.289</tspan>·h(v₃)</text>

      <text x="240" y="122" font-family="JetBrains Mono" font-size="11" fill="#b44a2f">  self:     0.250 × [1.0, 0.2] = [0.250, 0.050]</text>
      <text x="240" y="142" font-family="JetBrains Mono" font-size="11" fill="#2a6b5a">  from v₁:  0.289 × [0.4, 0.8] = [0.115, 0.231]</text>
      <text x="240" y="162" font-family="JetBrains Mono" font-size="11" fill="#3a5a8c">  from v₂:  0.250 × [0.7, 0.3] = [0.175, 0.075]</text>
      <text x="240" y="182" font-family="JetBrains Mono" font-size="11" fill="#8b5a8c">  from v₃:  0.289 × [0.2, 0.9] = [0.058, 0.260]</text>

      <line x1="240" y1="192" x2="500" y2="192" stroke="#d5d0c8" stroke-width="1"/>

      <text x="240" y="215" font-family="JetBrains Mono" font-size="12" fill="#b44a2f" font-weight="600">  SUM:                         = [0.598, 0.616]</text>

      <text x="240" y="248" font-family="Source Sans 3" font-size="11" fill="#2a2520">The input feature for v₀ was <tspan font-family="JetBrains Mono" font-size="10" font-weight="600">[1.0, 0.2]</tspan>.</text>
      <text x="240" y="268" font-family="Source Sans 3" font-size="11" fill="#2a2520">After aggregation: <tspan font-family="JetBrains Mono" font-size="10" font-weight="600">[0.598, 0.616]</tspan>.</text>
      <text x="240" y="288" font-family="Source Sans 3" font-size="11" fill="#6b6560" font-style="italic">→ Feature 1 dropped (diluted by lower-valued neighbors)</text>
      <text x="240" y="306" font-family="Source Sans 3" font-size="11" fill="#6b6560" font-style="italic">→ Feature 2 rose (pulled up by higher-valued neighbors)</text>
    </svg>
    <div class="caption"><strong>Figure 6.2.</strong> Tracing vertex $v_0$ through the aggregation step. Each neighbor contributes its feature vector, weighted by the normalization coefficient. The result is a smoothed feature that blends $v_0$'s own values with its neighborhood — exactly the kind of local averaging that makes GNNs powerful for tasks like heat prediction or community detection.</div>
  </div>

  <p>Repeating for all vertices, the full aggregated matrix is:</p>

  <div class="math-block">
    <div class="math-label">Aggregated features: $\hat{\mathbf{A}} \cdot \mathbf{H}^{(0)}$</div>
    $$\hat{\mathbf{A}} \cdot \mathbf{H}^{(0)} = \begin{pmatrix} 0.598 & 0.616 \\ 0.624 & 0.411 \\ 0.598 & 0.616 \\ 0.557 & 0.444 \end{pmatrix}$$
  </div>

  <p>
    Notice that vertices $v_0$ and $v_2$ get <em>identical</em> aggregated features. This makes sense — they have the same degree (3) and the same set of neighbors ($\{v_0/v_2, v_1, v_3\}$ plus self), so the weighted average is the same. This is a feature of GCN's symmetric normalization: structurally equivalent vertices get identical representations.
  </p>

  <h3>Step 2: Linear Transform — $(\hat{\mathbf{A}} \mathbf{H}^{(0)}) \cdot \mathbf{W}$</h3>

  <p>
    The weight matrix $\mathbf{W}^{(0)} \in \mathbb{R}^{2 \times 3}$ maps from 2 features to 3 features. These are the <strong>learnable parameters</strong> — the only part of the GCN that training adjusts:
  </p>

  <div class="figure">
    <svg viewBox="0 0 660 200" width="660" height="200">
      <text x="330" y="22" font-family="Source Sans 3" font-size="14" font-weight="700" fill="#2a2520" text-anchor="middle">Step 2: Linear Transform (Â·H⁰)·W</text>

      <rect x="20" y="42" width="620" height="145" rx="8" fill="#f8f4ee" stroke="#d5d0c8"/>

      <text x="35" y="68" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#2a2520">Weight matrix W⁰ (2×3) — learned during training:</text>
      <text x="35" y="92" font-family="JetBrains Mono" font-size="12" fill="#2a2520">W = [ 0.5  −0.3   0.8]    ← row for input feature 1</text>
      <text x="35" y="112" font-family="JetBrains Mono" font-size="12" fill="#2a2520">    [−0.2   0.7   0.4]    ← row for input feature 2</text>

      <text x="35" y="142" font-family="Source Sans 3" font-size="11" font-weight="600" fill="#2a2520">For vertex v₀:  ĥ(v₀) · W = [0.598, 0.616] · W</text>
      <text x="35" y="162" font-family="JetBrains Mono" font-size="11" fill="#2a2520">  out₁ = 0.598×(0.5) + 0.616×(−0.2) = 0.299 − 0.123 = <tspan fill="#b44a2f" font-weight="600">0.176</tspan></text>
      <text x="35" y="178" font-family="JetBrains Mono" font-size="11" fill="#2a2520">  out₂ = 0.598×(−0.3) + 0.616×(0.7) = −0.179 + 0.431 = <tspan fill="#b44a2f" font-weight="600">0.252</tspan></text>
    </svg>
    <div class="caption"><strong>Figure 6.3.</strong> The linear transform projects the aggregated 2D features into a 3D output space. The same weight matrix is applied at every vertex — this is the <em>parameter sharing</em> that makes GNNs efficient and equivariant.</div>
  </div>

  <h3>Step 3: Activation — $\sigma(\cdot)$</h3>

  <p>Apply ReLU element-wise: $\text{ReLU}(x) = \max(0, x)$. In our example, all pre-activation values happen to be positive, so nothing gets zeroed:</p>

  <div class="math-block">
    <div class="math-label">Final output: $\mathbf{H}^{(1)} = \text{ReLU}(\hat{\mathbf{A}} \mathbf{H}^{(0)} \mathbf{W}^{(0)})$</div>
    $$\mathbf{H}^{(1)} = \text{ReLU}\begin{pmatrix} 0.176 & 0.252 & 0.725 \\ 0.230 & 0.101 & 0.664 \\ 0.176 & 0.252 & 0.725 \\ 0.190 & 0.144 & 0.624 \end{pmatrix} = \begin{pmatrix} 0.176 & 0.252 & 0.725 \\ 0.230 & 0.101 & 0.664 \\ 0.176 & 0.252 & 0.725 \\ 0.190 & 0.144 & 0.624 \end{pmatrix}$$
  </div>

  <p>
    Each vertex now has a <strong>3-dimensional feature vector</strong> that encodes both its own original features <em>and</em> information from its neighbors. Vertex $v_0$ "knows" something about $v_1$, $v_2$, and $v_3$, even though it never saw their features directly — it received them through the aggregation step.
  </p>

  <h3>The Complete Pipeline — One Picture</h3>

  <div class="figure">
    <svg viewBox="0 0 700 270" width="700" height="270">
      <text x="350" y="22" font-family="Source Sans 3" font-size="14" font-weight="700" fill="#2a2520" text-anchor="middle">One GCN Layer: The Complete Data Flow</text>

      <!-- H0 -->
      <rect x="15" y="50" width="100" height="100" rx="6" fill="#e8a88a" fill-opacity="0.2" stroke="#b44a2f" stroke-width="1.5"/>
      <text x="65" y="45" font-family="Source Sans 3" font-size="10" font-weight="700" fill="#b44a2f" text-anchor="middle">H⁰ (4×2)</text>
      <text x="35" y="73" font-family="JetBrains Mono" font-size="8" fill="#2a2520">1.0  0.2</text>
      <text x="35" y="90" font-family="JetBrains Mono" font-size="8" fill="#2a2520">0.4  0.8</text>
      <text x="35" y="107" font-family="JetBrains Mono" font-size="8" fill="#2a2520">0.7  0.3</text>
      <text x="35" y="124" font-family="JetBrains Mono" font-size="8" fill="#2a2520">0.2  0.9</text>

      <!-- Arrow -->
      <line x1="115" y1="100" x2="148" y2="100" stroke="#6b6560" stroke-width="1.5" marker-end="url(#arr)"/>
      <text x="131" y="92" font-family="Source Sans 3" font-size="9" fill="#6b6560" text-anchor="middle">Â×</text>

      <!-- Aggregated -->
      <rect x="150" y="50" width="100" height="100" rx="6" fill="#8ec5b6" fill-opacity="0.2" stroke="#2a6b5a" stroke-width="1.5"/>
      <text x="200" y="45" font-family="Source Sans 3" font-size="10" font-weight="700" fill="#2a6b5a" text-anchor="middle">Â·H⁰ (4×2)</text>
      <text x="165" y="73" font-family="JetBrains Mono" font-size="8" fill="#2a2520">0.60  0.62</text>
      <text x="165" y="90" font-family="JetBrains Mono" font-size="8" fill="#2a2520">0.62  0.41</text>
      <text x="165" y="107" font-family="JetBrains Mono" font-size="8" fill="#2a2520">0.60  0.62</text>
      <text x="165" y="124" font-family="JetBrains Mono" font-size="8" fill="#2a2520">0.56  0.44</text>

      <!-- Arrow -->
      <line x1="250" y1="100" x2="283" y2="100" stroke="#6b6560" stroke-width="1.5" marker-end="url(#arr)"/>
      <text x="266" y="92" font-family="Source Sans 3" font-size="9" fill="#6b6560" text-anchor="middle">×W</text>

      <!-- Pre-activation -->
      <rect x="285" y="50" width="130" height="100" rx="6" fill="#a8c0e0" fill-opacity="0.2" stroke="#3a5a8c" stroke-width="1.5"/>
      <text x="350" y="45" font-family="Source Sans 3" font-size="10" font-weight="700" fill="#3a5a8c" text-anchor="middle">(Â·H⁰)·W (4×3)</text>
      <text x="300" y="73" font-family="JetBrains Mono" font-size="8" fill="#2a2520">.176  .252  .725</text>
      <text x="300" y="90" font-family="JetBrains Mono" font-size="8" fill="#2a2520">.230  .101  .664</text>
      <text x="300" y="107" font-family="JetBrains Mono" font-size="8" fill="#2a2520">.176  .252  .725</text>
      <text x="300" y="124" font-family="JetBrains Mono" font-size="8" fill="#2a2520">.190  .144  .624</text>

      <!-- Arrow -->
      <line x1="415" y1="100" x2="448" y2="100" stroke="#6b6560" stroke-width="1.5" marker-end="url(#arr)"/>
      <text x="431" y="92" font-family="Source Sans 3" font-size="9" fill="#6b6560" text-anchor="middle">ReLU</text>

      <!-- Output H1 -->
      <rect x="450" y="50" width="130" height="100" rx="6" fill="#c8a8d0" fill-opacity="0.2" stroke="#8b5a8c" stroke-width="1.5"/>
      <text x="515" y="45" font-family="Source Sans 3" font-size="10" font-weight="700" fill="#8b5a8c" text-anchor="middle">H¹ (4×3)</text>
      <text x="465" y="73" font-family="JetBrains Mono" font-size="8" fill="#2a2520">.176  .252  .725</text>
      <text x="465" y="90" font-family="JetBrains Mono" font-size="8" fill="#2a2520">.230  .101  .664</text>
      <text x="465" y="107" font-family="JetBrains Mono" font-size="8" fill="#2a2520">.176  .252  .725</text>
      <text x="465" y="124" font-family="JetBrains Mono" font-size="8" fill="#2a2520">.190  .144  .624</text>

      <!-- Annotations -->
      <text x="65" y="175" font-family="Source Sans 3" font-size="10" fill="#b44a2f" text-anchor="middle" font-weight="600">Each vertex</text>
      <text x="65" y="188" font-family="Source Sans 3" font-size="10" fill="#b44a2f" text-anchor="middle" font-weight="600">is isolated</text>

      <text x="200" y="175" font-family="Source Sans 3" font-size="10" fill="#2a6b5a" text-anchor="middle" font-weight="600">Neighbors</text>
      <text x="200" y="188" font-family="Source Sans 3" font-size="10" fill="#2a6b5a" text-anchor="middle" font-weight="600">are mixed in</text>

      <text x="350" y="175" font-family="Source Sans 3" font-size="10" fill="#3a5a8c" text-anchor="middle" font-weight="600">Projected to</text>
      <text x="350" y="188" font-family="Source Sans 3" font-size="10" fill="#3a5a8c" text-anchor="middle" font-weight="600">new dimension</text>

      <text x="515" y="175" font-family="Source Sans 3" font-size="10" fill="#8b5a8c" text-anchor="middle" font-weight="600">Nonlinearity</text>
      <text x="515" y="188" font-family="Source Sans 3" font-size="10" fill="#8b5a8c" text-anchor="middle" font-weight="600">applied</text>

      <!-- Receptive field note -->
      <rect x="100" y="210" width="500" height="48" rx="6" fill="#f8f4ee" stroke="#d5d0c8"/>
      <text x="350" y="232" font-family="Source Sans 3" font-size="11" fill="#2a2520" text-anchor="middle" font-weight="600">After 1 layer, each vertex knows about its immediate neighbors (1-hop).</text>
      <text x="350" y="250" font-family="Source Sans 3" font-size="11" fill="#6b6560" text-anchor="middle" font-style="italic">After 2 layers → 2-hop.  After k layers → k-hop.  This is the "receptive field."</text>

      <defs><marker id="arr" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#6b6560"/></marker></defs>
    </svg>
    <div class="caption"><strong>Figure 6.4.</strong> The complete data flow of one GCN layer. The 4×2 input is aggregated (mixed with neighbors), projected (2D → 3D by the learned weight matrix), and passed through ReLU. After one layer, each vertex's representation encodes its 1-hop neighborhood.</div>
  </div>
</section>

<hr class="divider">

<section id="sec7">
  <h2><span class="sec-num">07</span>Stacking Layers and the Receptive Field</h2>

  <p>
    A single layer gives each vertex access to its immediate neighbors. What happens with multiple layers?
  </p>

  <div class="figure">
    <svg viewBox="0 0 680 200" width="680" height="200">
      <text x="340" y="22" font-family="Source Sans 3" font-size="14" font-weight="700" fill="#2a2520" text-anchor="middle">Receptive Field Growth: How Information Propagates</text>

      <!-- Layer 0 -->
      <rect x="15" y="50" width="140" height="130" rx="8" fill="white" stroke="#d5d0c8"/>
      <text x="85" y="72" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#b44a2f" text-anchor="middle">Layer 0 (input)</text>
      <line x1="50" y1="110" x2="110" y2="90" stroke="#d5d0c8" stroke-width="1.5"/>
      <line x1="50" y1="110" x2="110" y2="140" stroke="#d5d0c8" stroke-width="1.5"/>
      <line x1="110" y1="90" x2="110" y2="140" stroke="#d5d0c8" stroke-width="1.5"/>
      <line x1="50" y1="110" x2="70" y2="160" stroke="#d5d0c8" stroke-width="1.5"/>
      <line x1="110" y1="140" x2="70" y2="160" stroke="#d5d0c8" stroke-width="1.5"/>
      <circle cx="50" cy="110" r="12" fill="#b44a2f" stroke="#8a2a1a" stroke-width="2"/>
      <circle cx="110" cy="90" r="9" fill="#e0d8d0" stroke="#b0a89e" stroke-width="1"/>
      <circle cx="110" cy="140" r="9" fill="#e0d8d0" stroke="#b0a89e" stroke-width="1"/>
      <circle cx="70" cy="160" r="9" fill="#e0d8d0" stroke="#b0a89e" stroke-width="1"/>
      <text x="50" y="114" fill="white" font-family="Source Sans 3" font-size="9" text-anchor="middle" font-weight="600">0</text>
      <text x="85" y="178" font-family="Source Sans 3" font-size="9" fill="#6b6560" text-anchor="middle">v₀ sees: only itself</text>

      <!-- Arrow -->
      <text x="175" y="120" font-family="Source Sans 3" font-size="14" fill="#6b6560">→</text>

      <!-- Layer 1 -->
      <rect x="195" y="50" width="140" height="130" rx="8" fill="white" stroke="#d5d0c8"/>
      <text x="265" y="72" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#2a6b5a" text-anchor="middle">After 1 layer</text>
      <line x1="230" y1="110" x2="290" y2="90" stroke="#2a6b5a" stroke-width="2"/>
      <line x1="230" y1="110" x2="290" y2="140" stroke="#2a6b5a" stroke-width="2"/>
      <line x1="290" y1="90" x2="290" y2="140" stroke="#d5d0c8" stroke-width="1.5"/>
      <line x1="230" y1="110" x2="250" y2="160" stroke="#2a6b5a" stroke-width="2"/>
      <line x1="290" y1="140" x2="250" y2="160" stroke="#d5d0c8" stroke-width="1.5"/>
      <circle cx="230" cy="110" r="12" fill="#b44a2f" stroke="#8a2a1a" stroke-width="2"/>
      <circle cx="290" cy="90" r="10" fill="#8ec5b6" stroke="#2a6b5a" stroke-width="1.5"/>
      <circle cx="290" cy="140" r="10" fill="#8ec5b6" stroke="#2a6b5a" stroke-width="1.5"/>
      <circle cx="250" cy="160" r="10" fill="#8ec5b6" stroke="#2a6b5a" stroke-width="1.5"/>
      <text x="230" y="114" fill="white" font-family="Source Sans 3" font-size="9" text-anchor="middle" font-weight="600">0</text>
      <text x="265" y="178" font-family="Source Sans 3" font-size="9" fill="#6b6560" text-anchor="middle">v₀ sees: 1-hop (v1,v2,v3)</text>

      <!-- Arrow -->
      <text x="355" y="120" font-family="Source Sans 3" font-size="14" fill="#6b6560">→</text>

      <!-- Layer 2 -->
      <rect x="375" y="50" width="140" height="130" rx="8" fill="white" stroke="#d5d0c8"/>
      <text x="445" y="72" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#3a5a8c" text-anchor="middle">After 2 layers</text>
      <line x1="410" y1="110" x2="470" y2="90" stroke="#3a5a8c" stroke-width="2"/>
      <line x1="410" y1="110" x2="470" y2="140" stroke="#3a5a8c" stroke-width="2"/>
      <line x1="470" y1="90" x2="470" y2="140" stroke="#3a5a8c" stroke-width="2"/>
      <line x1="410" y1="110" x2="430" y2="160" stroke="#3a5a8c" stroke-width="2"/>
      <line x1="470" y1="140" x2="430" y2="160" stroke="#3a5a8c" stroke-width="2"/>
      <circle cx="410" cy="110" r="12" fill="#b44a2f" stroke="#8a2a1a" stroke-width="2"/>
      <circle cx="470" cy="90" r="10" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1.5"/>
      <circle cx="470" cy="140" r="10" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1.5"/>
      <circle cx="430" cy="160" r="10" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1.5"/>
      <text x="410" y="114" fill="white" font-family="Source Sans 3" font-size="9" text-anchor="middle" font-weight="600">0</text>
      <text x="445" y="178" font-family="Source Sans 3" font-size="9" fill="#6b6560" text-anchor="middle">v₀ sees: entire graph</text>

      <!-- Insight -->
      <rect x="540" y="60" width="140" height="110" rx="6" fill="#f8f4ee" stroke="#d5d0c8"/>
      <text x="555" y="82" font-family="Source Sans 3" font-size="10" font-weight="700" fill="#2a2520">On this graph:</text>
      <text x="555" y="102" font-family="Source Sans 3" font-size="10" fill="#2a2520">Diameter = 2</text>
      <text x="555" y="118" font-family="Source Sans 3" font-size="10" fill="#2a2520">So 2 layers suffice</text>
      <text x="555" y="134" font-family="Source Sans 3" font-size="10" fill="#2a2520">for global info.</text>
      <text x="555" y="158" font-family="Source Sans 3" font-size="10" fill="#b44a2f" font-weight="600">Too many layers →</text>
      <text x="555" y="173" font-family="Source Sans 3" font-size="10" fill="#b44a2f" font-weight="600">"oversmoothing"</text>
    </svg>
    <div class="caption"><strong>Figure 7.1.</strong> Receptive field growth. After $k$ GCN layers, each vertex has aggregated information from all vertices within $k$ hops. On our small graph (diameter 2), two layers already give every vertex a global view. On large graphs, this creates the classic GNN trade-off: more layers = wider receptive field, but also more risk of "oversmoothing" where all vertex representations converge.</div>
  </div>

  <h3>A Larger Example: The Two-Community Graph</h3>

  <p>
    Our 4-node graph has diameter 2, so the receptive field saturates after just 2 layers — every vertex already sees everything. Let's see what happens on a larger graph where depth genuinely matters: a <strong>32-node "two-community" graph</strong> with diameter &approx; 7.
  </p>

  <div class="figure">
    <svg viewBox="0 0 700 320" width="700" height="320">
      <text x="350" y="22" font-family="Source Sans 3" font-size="14" font-weight="700" fill="#2a2520" text-anchor="middle">Figure 7.2 — Two-Community Graph (32 nodes, ~60 edges)</text>

      <!-- Cluster A background -->
      <ellipse cx="195" cy="175" rx="165" ry="120" fill="#e8a88a" fill-opacity="0.1" stroke="#b44a2f" stroke-width="1" stroke-dasharray="4,3"/>
      <text x="195" y="56" font-family="Source Sans 3" font-size="12" font-weight="700" fill="#b44a2f" text-anchor="middle">Cluster A (v₀–v₁₅)</text>

      <!-- Cluster B background -->
      <ellipse cx="520" cy="175" rx="155" ry="120" fill="#a8c0e0" fill-opacity="0.1" stroke="#3a5a8c" stroke-width="1" stroke-dasharray="4,3"/>
      <text x="520" y="56" font-family="Source Sans 3" font-size="12" font-weight="700" fill="#3a5a8c" text-anchor="middle">Cluster B (v₁₆–v₃₁)</text>

      <!-- Cluster A edges (representative) -->
      <line x1="100" y1="140" x2="150" y2="110" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="100" y1="140" x2="140" y2="175" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="150" y1="110" x2="200" y2="100" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="150" y1="110" x2="140" y2="175" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="200" y1="100" x2="250" y2="120" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="200" y1="100" x2="195" y2="160" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="140" y1="175" x2="195" y2="160" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="195" y1="160" x2="250" y2="120" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="250" y1="120" x2="280" y2="160" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="140" y1="175" x2="110" y2="220" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="195" y1="160" x2="170" y2="220" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="110" y1="220" x2="170" y2="220" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="170" y1="220" x2="230" y2="230" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="230" y1="230" x2="280" y2="160" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="100" y1="140" x2="80" y2="195" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="80" y1="195" x2="110" y2="220" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>

      <!-- Cluster B edges (representative) -->
      <line x1="430" y1="140" x2="480" y2="110" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="430" y1="140" x2="460" y2="175" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="480" y1="110" x2="530" y2="100" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="480" y1="110" x2="460" y2="175" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="530" y1="100" x2="580" y2="120" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="530" y1="100" x2="520" y2="160" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="460" y1="175" x2="520" y2="160" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="520" y1="160" x2="580" y2="120" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="580" y1="120" x2="610" y2="160" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="460" y1="175" x2="440" y2="220" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="520" y1="160" x2="500" y2="220" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="440" y1="220" x2="500" y2="220" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="500" y1="220" x2="560" y2="230" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="560" y1="230" x2="610" y2="160" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="430" y1="140" x2="410" y2="195" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>
      <line x1="410" y1="195" x2="440" y2="220" class="edge-line" stroke="#d5d0c8" stroke-width="1"/>

      <!-- Bridge edges — prominent -->
      <line x1="280" y1="160" x2="430" y2="140" stroke="#b44a2f" stroke-width="2.5" stroke-dasharray="6,3"/>
      <line x1="230" y1="230" x2="500" y2="220" stroke="#b44a2f" stroke-width="2.5" stroke-dasharray="6,3"/>

      <!-- Cluster A nodes -->
      <circle cx="100" cy="140" r="10" fill="#b44a2f" stroke="#8a2a1a" stroke-width="2.5"/>
      <text x="100" y="144" fill="white" font-family="Source Sans 3" font-size="8" text-anchor="middle" font-weight="700">v₀</text>
      <circle cx="150" cy="110" r="7" fill="#e8a88a" stroke="#b44a2f" stroke-width="1.5"/>
      <circle cx="200" cy="100" r="7" fill="#e8a88a" stroke="#b44a2f" stroke-width="1.5"/>
      <circle cx="140" cy="175" r="7" fill="#e8a88a" stroke="#b44a2f" stroke-width="1.5"/>
      <circle cx="195" cy="160" r="7" fill="#e8a88a" stroke="#b44a2f" stroke-width="1.5"/>
      <circle cx="250" cy="120" r="7" fill="#e8a88a" stroke="#b44a2f" stroke-width="1.5"/>
      <circle cx="280" cy="160" r="8" fill="#e8a88a" stroke="#b44a2f" stroke-width="2"/>
      <text x="280" y="152" font-family="Source Sans 3" font-size="7" fill="#b44a2f" text-anchor="middle" font-weight="600">v₇</text>
      <circle cx="80" cy="195" r="5" fill="#e8a88a" stroke="#b44a2f" stroke-width="1"/>
      <circle cx="110" cy="220" r="5" fill="#e8a88a" stroke="#b44a2f" stroke-width="1"/>
      <circle cx="170" cy="220" r="5" fill="#e8a88a" stroke="#b44a2f" stroke-width="1"/>
      <circle cx="230" cy="230" r="8" fill="#e8a88a" stroke="#b44a2f" stroke-width="2"/>
      <text x="230" y="246" font-family="Source Sans 3" font-size="7" fill="#b44a2f" text-anchor="middle" font-weight="600">v₁₂</text>
      <!-- Ellipsis dots for remaining A nodes -->
      <circle cx="255" cy="195" r="2" fill="#b44a2f"/>
      <circle cx="265" cy="200" r="2" fill="#b44a2f"/>
      <circle cx="275" cy="205" r="2" fill="#b44a2f"/>

      <!-- Cluster B nodes -->
      <circle cx="430" cy="140" r="8" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="2"/>
      <text x="430" y="132" font-family="Source Sans 3" font-size="7" fill="#3a5a8c" text-anchor="middle" font-weight="600">v₁₆</text>
      <circle cx="480" cy="110" r="7" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1.5"/>
      <circle cx="530" cy="100" r="7" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1.5"/>
      <circle cx="460" cy="175" r="7" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1.5"/>
      <circle cx="520" cy="160" r="7" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1.5"/>
      <circle cx="580" cy="120" r="7" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1.5"/>
      <circle cx="610" cy="160" r="7" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1.5"/>
      <circle cx="410" cy="195" r="5" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1"/>
      <circle cx="440" cy="220" r="5" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1"/>
      <circle cx="500" cy="220" r="8" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="2"/>
      <text x="500" y="236" font-family="Source Sans 3" font-size="7" fill="#3a5a8c" text-anchor="middle" font-weight="600">v₂₄</text>
      <circle cx="560" cy="230" r="5" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1"/>
      <!-- Ellipsis dots for remaining B nodes -->
      <circle cx="440" cy="250" r="2" fill="#3a5a8c"/>
      <circle cx="450" cy="255" r="2" fill="#3a5a8c"/>
      <circle cx="460" cy="260" r="2" fill="#3a5a8c"/>

      <!-- Bridge labels -->
      <text x="355" y="138" font-family="Source Sans 3" font-size="9" fill="#b44a2f" text-anchor="middle" font-weight="700">bridge</text>
      <text x="365" y="218" font-family="Source Sans 3" font-size="9" fill="#b44a2f" text-anchor="middle" font-weight="700">bridge</text>

      <!-- Annotation box -->
      <rect x="120" y="270" width="470" height="40" rx="6" fill="#f8f4ee" stroke="#d5d0c8"/>
      <text x="355" y="288" font-family="Source Sans 3" font-size="10" fill="#2a2520" text-anchor="middle">16 nodes per cluster · avg degree ≈ 4 within cluster · <tspan font-weight="700" fill="#b44a2f">2 bridge edges</tspan> between clusters</text>
      <text x="355" y="303" font-family="Source Sans 3" font-size="10" fill="#6b6560" text-anchor="middle">Diameter ≈ 7 — must traverse within cluster + cross bridge + traverse other cluster</text>
    </svg>
    <div class="caption"><strong>Figure 7.2.</strong> A two-community graph with 32 vertices. Each cluster has dense internal connections (avg degree ~4), but only two bridge edges connect the clusters. Target vertex $v_0$ (highlighted, deep inside cluster A) would need 7+ hops to reach the far side of cluster B. This makes the receptive field concept non-trivial: 3 layers is <em>not</em> enough for $v_0$ to see the whole graph.</div>
  </div>

  <h3>Architecture: A 3-Layer GCN (1 → 3 → 3 → 1)</h3>

  <p>
    Each vertex starts with a single scalar feature (e.g., temperature). We stack three GCN layers in an "expand → refine → compress" pattern:
  </p>

  <div class="figure">
    <svg viewBox="0 0 700 250" width="700" height="250">
      <text x="350" y="22" font-family="Source Sans 3" font-size="14" font-weight="700" fill="#2a2520" text-anchor="middle">Figure 7.3 — 3-Layer GCN Pipeline: Tensor Shapes</text>

      <!-- Layer boxes -->
      <!-- Input -->
      <rect x="15" y="55" width="68" height="60" rx="5" fill="#e8a88a" fill-opacity="0.2" stroke="#b44a2f" stroke-width="1.5"/>
      <text x="49" y="50" font-family="Source Sans 3" font-size="9" font-weight="700" fill="#b44a2f" text-anchor="middle">Input</text>
      <text x="49" y="78" font-family="JetBrains Mono" font-size="10" fill="#2a2520" text-anchor="middle">H⁰</text>
      <text x="49" y="98" font-family="JetBrains Mono" font-size="9" fill="#6b6560" text-anchor="middle">32×1</text>

      <!-- Arrow + Â -->
      <line x1="83" y1="85" x2="108" y2="85" stroke="#6b6560" stroke-width="1.5" marker-end="url(#arr7)"/>
      <text x="96" y="78" font-family="JetBrains Mono" font-size="8" fill="#2a6b5a" text-anchor="middle">Â</text>

      <!-- ÂH⁰ -->
      <rect x="110" y="65" width="50" height="40" rx="4" fill="#8ec5b6" fill-opacity="0.15" stroke="#2a6b5a" stroke-width="1" stroke-dasharray="3,2"/>
      <text x="135" y="90" font-family="JetBrains Mono" font-size="8" fill="#6b6560" text-anchor="middle">32×1</text>

      <!-- Arrow + W⁰ -->
      <line x1="160" y1="85" x2="185" y2="85" stroke="#6b6560" stroke-width="1.5" marker-end="url(#arr7)"/>
      <text x="173" y="78" font-family="JetBrains Mono" font-size="8" fill="#b44a2f" text-anchor="middle">W⁰</text>

      <!-- After W⁰ -->
      <rect x="187" y="65" width="50" height="40" rx="4" fill="#a8c0e0" fill-opacity="0.15" stroke="#3a5a8c" stroke-width="1" stroke-dasharray="3,2"/>
      <text x="212" y="90" font-family="JetBrains Mono" font-size="8" fill="#6b6560" text-anchor="middle">32×3</text>

      <!-- Arrow + σ -->
      <line x1="237" y1="85" x2="262" y2="85" stroke="#6b6560" stroke-width="1.5" marker-end="url(#arr7)"/>
      <text x="250" y="78" font-family="JetBrains Mono" font-size="8" fill="#8b5a8c" text-anchor="middle">σ</text>

      <!-- H¹ -->
      <rect x="264" y="55" width="55" height="60" rx="5" fill="#8ec5b6" fill-opacity="0.2" stroke="#2a6b5a" stroke-width="1.5"/>
      <text x="291" y="50" font-family="Source Sans 3" font-size="9" font-weight="700" fill="#2a6b5a" text-anchor="middle">Layer 1</text>
      <text x="291" y="78" font-family="JetBrains Mono" font-size="10" fill="#2a2520" text-anchor="middle">H¹</text>
      <text x="291" y="98" font-family="JetBrains Mono" font-size="9" fill="#6b6560" text-anchor="middle">32×3</text>

      <!-- Arrow + Â -->
      <line x1="319" y1="85" x2="344" y2="85" stroke="#6b6560" stroke-width="1.5" marker-end="url(#arr7)"/>
      <text x="332" y="78" font-family="JetBrains Mono" font-size="8" fill="#2a6b5a" text-anchor="middle">Â</text>

      <!-- ÂH¹ -->
      <rect x="346" y="65" width="50" height="40" rx="4" fill="#8ec5b6" fill-opacity="0.15" stroke="#2a6b5a" stroke-width="1" stroke-dasharray="3,2"/>
      <text x="371" y="90" font-family="JetBrains Mono" font-size="8" fill="#6b6560" text-anchor="middle">32×3</text>

      <!-- Arrow + W¹ -->
      <line x1="396" y1="85" x2="421" y2="85" stroke="#6b6560" stroke-width="1.5" marker-end="url(#arr7)"/>
      <text x="409" y="78" font-family="JetBrains Mono" font-size="8" fill="#b44a2f" text-anchor="middle">W¹</text>

      <!-- After W¹ -->
      <rect x="423" y="65" width="50" height="40" rx="4" fill="#a8c0e0" fill-opacity="0.15" stroke="#3a5a8c" stroke-width="1" stroke-dasharray="3,2"/>
      <text x="448" y="90" font-family="JetBrains Mono" font-size="8" fill="#6b6560" text-anchor="middle">32×3</text>

      <!-- Arrow + σ -->
      <line x1="473" y1="85" x2="498" y2="85" stroke="#6b6560" stroke-width="1.5" marker-end="url(#arr7)"/>
      <text x="486" y="78" font-family="JetBrains Mono" font-size="8" fill="#8b5a8c" text-anchor="middle">σ</text>

      <!-- H² -->
      <rect x="500" y="55" width="55" height="60" rx="5" fill="#a8c0e0" fill-opacity="0.2" stroke="#3a5a8c" stroke-width="1.5"/>
      <text x="527" y="50" font-family="Source Sans 3" font-size="9" font-weight="700" fill="#3a5a8c" text-anchor="middle">Layer 2</text>
      <text x="527" y="78" font-family="JetBrains Mono" font-size="10" fill="#2a2520" text-anchor="middle">H²</text>
      <text x="527" y="98" font-family="JetBrains Mono" font-size="9" fill="#6b6560" text-anchor="middle">32×3</text>

      <!-- Arrow to layer 3 (wraps down) -->
      <line x1="555" y1="85" x2="570" y2="85" stroke="#6b6560" stroke-width="1.5"/>
      <line x1="570" y1="85" x2="570" y2="165" stroke="#6b6560" stroke-width="1.5"/>
      <line x1="570" y1="165" x2="555" y2="165" stroke="#6b6560" stroke-width="1.5" marker-end="url(#arr7l)"/>

      <!-- Row 2: Layer 3 -->
      <text x="530" y="148" font-family="JetBrains Mono" font-size="8" fill="#2a6b5a" text-anchor="middle">Â</text>

      <!-- ÂH² -->
      <rect x="490" y="150" width="50" height="40" rx="4" fill="#8ec5b6" fill-opacity="0.15" stroke="#2a6b5a" stroke-width="1" stroke-dasharray="3,2"/>
      <text x="515" y="175" font-family="JetBrains Mono" font-size="8" fill="#6b6560" text-anchor="middle">32×3</text>

      <!-- Arrow + W² -->
      <line x1="490" y1="170" x2="465" y2="170" stroke="#6b6560" stroke-width="1.5" marker-end="url(#arr7l)"/>
      <text x="478" y="163" font-family="JetBrains Mono" font-size="8" fill="#b44a2f" text-anchor="middle">W²</text>

      <!-- After W² -->
      <rect x="405" y="150" width="50" height="40" rx="4" fill="#a8c0e0" fill-opacity="0.15" stroke="#3a5a8c" stroke-width="1" stroke-dasharray="3,2"/>
      <text x="430" y="175" font-family="JetBrains Mono" font-size="8" fill="#6b6560" text-anchor="middle">32×1</text>

      <!-- Arrow + σ -->
      <line x1="405" y1="170" x2="380" y2="170" stroke="#6b6560" stroke-width="1.5" marker-end="url(#arr7l)"/>
      <text x="393" y="163" font-family="JetBrains Mono" font-size="8" fill="#8b5a8c" text-anchor="middle">σ</text>

      <!-- H³ (output) -->
      <rect x="310" y="140" width="68" height="60" rx="5" fill="#c8a8d0" fill-opacity="0.2" stroke="#8b5a8c" stroke-width="1.5"/>
      <text x="344" y="135" font-family="Source Sans 3" font-size="9" font-weight="700" fill="#8b5a8c" text-anchor="middle">Output</text>
      <text x="344" y="163" font-family="JetBrains Mono" font-size="10" fill="#2a2520" text-anchor="middle">H³</text>
      <text x="344" y="183" font-family="JetBrains Mono" font-size="9" fill="#6b6560" text-anchor="middle">32×1</text>

      <!-- Phase labels -->
      <rect x="50" y="215" width="180" height="28" rx="5" fill="#b44a2f" fill-opacity="0.1" stroke="#b44a2f" stroke-width="1"/>
      <text x="140" y="234" font-family="Source Sans 3" font-size="10" fill="#b44a2f" text-anchor="middle" font-weight="600">Layer 1: Expand (1→3)</text>

      <rect x="260" y="215" width="180" height="28" rx="5" fill="#3a5a8c" fill-opacity="0.1" stroke="#3a5a8c" stroke-width="1"/>
      <text x="350" y="234" font-family="Source Sans 3" font-size="10" fill="#3a5a8c" text-anchor="middle" font-weight="600">Layer 2: Refine (3→3)</text>

      <rect x="460" y="215" width="180" height="28" rx="5" fill="#8b5a8c" fill-opacity="0.1" stroke="#8b5a8c" stroke-width="1"/>
      <text x="550" y="234" font-family="Source Sans 3" font-size="10" fill="#8b5a8c" text-anchor="middle" font-weight="600">Layer 3: Compress (3→1)</text>

      <defs>
        <marker id="arr7" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="5" markerHeight="5" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#6b6560"/></marker>
        <marker id="arr7l" viewBox="0 0 10 10" refX="1" refY="5" markerWidth="5" markerHeight="5" orient="auto"><path d="M 10 0 L 0 5 L 10 10 z" fill="#6b6560"/></marker>
      </defs>
    </svg>
    <div class="caption"><strong>Figure 7.3.</strong> Data flow through 3 GCN layers. Each layer applies the same $\hat{\mathbf{A}}$ (the 32&times;32 normalized adjacency — fixed, not learned) followed by a different $\mathbf{W}^{(\ell)}$ (learned). The weight matrices control the dimension changes: $\mathbf{W}^{(0)} \in \mathbb{R}^{1 \times 3}$ expands from scalar to 3D, $\mathbf{W}^{(1)} \in \mathbb{R}^{3 \times 3}$ refines within 3D, and $\mathbf{W}^{(2)} \in \mathbb{R}^{3 \times 1}$ compresses back to a scalar prediction.</div>
  </div>

  <h3>Tracking $v_0$'s Receptive Field Across 3 Layers</h3>

  <p>
    Let's follow vertex $v_0$ (deep inside cluster A) and track exactly which vertices contribute to its representation after each layer:
  </p>

  <div class="figure">
    <svg viewBox="0 0 700 380" width="700" height="380">
      <text x="350" y="22" font-family="Source Sans 3" font-size="14" font-weight="700" fill="#2a2520" text-anchor="middle">Figure 7.4 — Receptive Field of v₀ After Each Layer</text>

      <!-- Panel 1: Input -->
      <rect x="15" y="42" width="155" height="170" rx="8" fill="white" stroke="#d5d0c8"/>
      <text x="92" y="62" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#b44a2f" text-anchor="middle">Input (Layer 0)</text>

      <!-- Schematic cluster A -->
      <ellipse cx="72" cy="125" rx="50" ry="38" fill="#faf8f5" stroke="#d5d0c8" stroke-width="0.5"/>
      <!-- Bridge region hint -->
      <circle cx="120" cy="115" r="3" fill="#e0d8d0" stroke="#b0a89e" stroke-width="0.5"/>
      <circle cx="95" cy="100" r="3" fill="#e0d8d0" stroke="#b0a89e" stroke-width="0.5"/>
      <circle cx="55" cy="140" r="3" fill="#e0d8d0" stroke="#b0a89e" stroke-width="0.5"/>
      <circle cx="80" cy="150" r="3" fill="#e0d8d0" stroke="#b0a89e" stroke-width="0.5"/>
      <circle cx="100" cy="138" r="3" fill="#e0d8d0" stroke="#b0a89e" stroke-width="0.5"/>
      <circle cx="65" cy="108" r="3" fill="#e0d8d0" stroke="#b0a89e" stroke-width="0.5"/>
      <!-- v₀ highlighted -->
      <circle cx="50" cy="120" r="8" fill="#b44a2f" stroke="#8a2a1a" stroke-width="2"/>
      <text x="50" y="124" fill="white" font-family="Source Sans 3" font-size="7" text-anchor="middle" font-weight="700">v₀</text>

      <text x="92" y="182" font-family="JetBrains Mono" font-size="9" fill="#b44a2f" text-anchor="middle" font-weight="600">1 vertex</text>
      <text x="92" y="198" font-family="Source Sans 3" font-size="9" fill="#6b6560" text-anchor="middle">v₀ knows only itself</text>

      <!-- Panel 2: After Layer 1 -->
      <rect x="185" y="42" width="155" height="170" rx="8" fill="white" stroke="#d5d0c8"/>
      <text x="262" y="62" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#2a6b5a" text-anchor="middle">After Layer 1</text>

      <ellipse cx="242" cy="125" rx="50" ry="38" fill="#faf8f5" stroke="#d5d0c8" stroke-width="0.5"/>
      <circle cx="290" cy="115" r="3" fill="#e0d8d0" stroke="#b0a89e" stroke-width="0.5"/>
      <circle cx="250" cy="150" r="3" fill="#e0d8d0" stroke="#b0a89e" stroke-width="0.5"/>
      <circle cx="270" cy="138" r="3" fill="#e0d8d0" stroke="#b0a89e" stroke-width="0.5"/>
      <!-- 1-hop neighbors highlighted -->
      <line x1="220" y1="120" x2="235" y2="108" stroke="#2a6b5a" stroke-width="1.5"/>
      <line x1="220" y1="120" x2="265" y2="108" stroke="#2a6b5a" stroke-width="1.5"/>
      <line x1="220" y1="120" x2="225" y2="140" stroke="#2a6b5a" stroke-width="1.5"/>
      <circle cx="235" cy="108" r="5" fill="#8ec5b6" stroke="#2a6b5a" stroke-width="1.5"/>
      <circle cx="265" cy="108" r="5" fill="#8ec5b6" stroke="#2a6b5a" stroke-width="1.5"/>
      <circle cx="225" cy="140" r="5" fill="#8ec5b6" stroke="#2a6b5a" stroke-width="1.5"/>
      <circle cx="220" cy="120" r="8" fill="#b44a2f" stroke="#8a2a1a" stroke-width="2"/>
      <text x="220" y="124" fill="white" font-family="Source Sans 3" font-size="7" text-anchor="middle" font-weight="700">v₀</text>

      <text x="262" y="182" font-family="JetBrains Mono" font-size="9" fill="#2a6b5a" text-anchor="middle" font-weight="600">~5 vertices</text>
      <text x="262" y="198" font-family="Source Sans 3" font-size="9" fill="#6b6560" text-anchor="middle">1-hop, all in cluster A</text>

      <!-- Panel 3: After Layer 2 -->
      <rect x="355" y="42" width="155" height="170" rx="8" fill="white" stroke="#d5d0c8"/>
      <text x="432" y="62" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#3a5a8c" text-anchor="middle">After Layer 2</text>

      <ellipse cx="412" cy="125" rx="50" ry="38" fill="#a8c0e0" fill-opacity="0.12" stroke="#3a5a8c" stroke-width="0.8"/>
      <!-- 2-hop region — most of cluster A lit up -->
      <circle cx="460" cy="115" r="4" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1"/>
      <circle cx="420" cy="150" r="4" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1"/>
      <circle cx="440" cy="138" r="4" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1"/>
      <circle cx="385" cy="145" r="4" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1"/>
      <circle cx="400" cy="105" r="4" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1"/>
      <line x1="390" y1="120" x2="405" y2="108" stroke="#3a5a8c" stroke-width="1"/>
      <line x1="390" y1="120" x2="430" y2="110" stroke="#3a5a8c" stroke-width="1"/>
      <line x1="390" y1="120" x2="395" y2="140" stroke="#3a5a8c" stroke-width="1"/>
      <circle cx="405" cy="108" r="5" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1.2"/>
      <circle cx="430" cy="110" r="5" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1.2"/>
      <circle cx="395" cy="140" r="5" fill="#a8c0e0" stroke="#3a5a8c" stroke-width="1.2"/>
      <circle cx="390" cy="120" r="8" fill="#b44a2f" stroke="#8a2a1a" stroke-width="2"/>
      <text x="390" y="124" fill="white" font-family="Source Sans 3" font-size="7" text-anchor="middle" font-weight="700">v₀</text>

      <text x="432" y="182" font-family="JetBrains Mono" font-size="9" fill="#3a5a8c" text-anchor="middle" font-weight="600">~12–15 vertices</text>
      <text x="432" y="198" font-family="Source Sans 3" font-size="9" fill="#6b6560" text-anchor="middle">2-hop, still cluster A only</text>

      <!-- Panel 4: After Layer 3 -->
      <rect x="525" y="42" width="160" height="170" rx="8" fill="white" stroke="#d5d0c8"/>
      <text x="605" y="62" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#8b5a8c" text-anchor="middle">After Layer 3</text>

      <!-- Both clusters shown small -->
      <ellipse cx="570" cy="125" rx="30" ry="25" fill="#e8a88a" fill-opacity="0.15" stroke="#b44a2f" stroke-width="0.8"/>
      <ellipse cx="640" cy="125" rx="25" ry="20" fill="#a8c0e0" fill-opacity="0.15" stroke="#3a5a8c" stroke-width="0.8"/>
      <!-- Bridge -->
      <line x1="598" y1="118" x2="618" y2="118" stroke="#8b5a8c" stroke-width="2" stroke-dasharray="3,2"/>
      <!-- Most of cluster A lit -->
      <circle cx="555" cy="118" r="3" fill="#c8a8d0" stroke="#8b5a8c" stroke-width="1"/>
      <circle cx="575" cy="110" r="3" fill="#c8a8d0" stroke="#8b5a8c" stroke-width="1"/>
      <circle cx="585" cy="130" r="3" fill="#c8a8d0" stroke="#8b5a8c" stroke-width="1"/>
      <circle cx="565" cy="138" r="3" fill="#c8a8d0" stroke="#8b5a8c" stroke-width="1"/>
      <circle cx="590" cy="115" r="4" fill="#c8a8d0" stroke="#8b5a8c" stroke-width="1"/>
      <!-- Just touching cluster B -->
      <circle cx="625" cy="120" r="4" fill="#c8a8d0" stroke="#8b5a8c" stroke-width="1.2"/>
      <circle cx="640" cy="115" r="2.5" fill="#e0d8d0" stroke="#b0a89e" stroke-width="0.5"/>
      <circle cx="650" cy="128" r="2.5" fill="#e0d8d0" stroke="#b0a89e" stroke-width="0.5"/>
      <circle cx="560" cy="125" r="6" fill="#b44a2f" stroke="#8a2a1a" stroke-width="1.5"/>
      <text x="560" y="128" fill="white" font-family="Source Sans 3" font-size="6" text-anchor="middle" font-weight="700">v₀</text>

      <text x="605" y="182" font-family="JetBrains Mono" font-size="9" fill="#8b5a8c" text-anchor="middle" font-weight="600">~18–20 vertices</text>
      <text x="605" y="198" font-family="Source Sans 3" font-size="9" fill="#6b6560" text-anchor="middle">3-hop, just crosses bridge</text>

      <!-- Key insight below panels -->
      <rect x="15" y="230" width="670" height="55" rx="6" fill="#f8f4ee" stroke="#b44a2f" stroke-width="1"/>
      <text x="350" y="252" font-family="Source Sans 3" font-size="11" fill="#2a2520" text-anchor="middle" font-weight="600">After 3 layers, v₀ has just reached the bridge vertex v₇ → v₁₆ → barely touching cluster B.</text>
      <text x="350" y="272" font-family="Source Sans 3" font-size="11" fill="#6b6560" text-anchor="middle">With diameter ≈ 7, v₀ would need 7+ layers to see the entire graph. <tspan fill="#b44a2f" font-weight="600">3 layers ≈ 50% coverage.</tspan></text>

      <!-- Contrast note -->
      <rect x="15" y="300" width="670" height="70" rx="6" fill="white" stroke="#d5d0c8"/>
      <text x="35" y="322" font-family="Source Sans 3" font-size="11" fill="#2a2520"><tspan font-weight="700">Contrast with our 4-node graph:</tspan> diameter 2 meant 2 layers gave 100% coverage.</text>
      <text x="35" y="342" font-family="Source Sans 3" font-size="11" fill="#2a2520">Here, 3 layers only covers about half the graph — <tspan font-weight="700" fill="#2a6b5a">and that's often a feature, not a bug.</tspan></text>
      <text x="35" y="362" font-family="Source Sans 3" font-size="11" fill="#6b6560">For tasks like "predict v₀'s community label," local information may be all you need.</text>
    </svg>
    <div class="caption"><strong>Figure 7.4.</strong> Receptive field of $v_0$ after each GCN layer on the two-community graph. Layer 1 reaches direct neighbors (~5 vertices). Layer 2 extends to 2-hop (~12–15 vertices, still entirely within cluster A). Layer 3 finally reaches the bridge vertex $v_7$, crossing into cluster B for the first time. With diameter &approx; 7, three layers give only partial coverage — and for many tasks, this local view is sufficient and even preferable to a global one.</div>
  </div>

  <div class="insight key">
    <p><strong>What the hidden dimension does:</strong> The 1 → 3 → 3 → 1 funnel isn't arbitrary. Layer 1 expands each scalar to a 3D vector so the network can learn three different "views" of the aggregated neighborhood — perhaps one channel capturing magnitude, another gradient, another curvature. Layer 2 mixes these views with the next ring of neighbors' 3D representations, allowing richer feature interactions. Layer 3 compresses back to a scalar prediction. The hidden dimension (3 here) controls the network's <em>capacity</em> — its ability to represent different mixing patterns. Too small and it can't distinguish neighborhoods; too large and it overfits.</p>
  </div>

  <h3>Feature Smoothing and the Heat Diffusion Connection</h3>

  <p>
    Each application of $\hat{\mathbf{A}}$ averages a vertex's features with its neighbors' — this is literally a <strong>diffusion step</strong>. Let's visualize what happens to the feature distribution across vertices as we stack layers:
  </p>

  <div class="figure">
    <svg viewBox="0 0 700 300" width="700" height="300">
      <text x="350" y="22" font-family="Source Sans 3" font-size="14" font-weight="700" fill="#2a2520" text-anchor="middle">Figure 7.5 — Feature Smoothing Across Layers</text>

      <!-- Layer 0 panel -->
      <rect x="15" y="45" width="155" height="165" rx="8" fill="white" stroke="#d5d0c8"/>
      <text x="92" y="65" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#b44a2f" text-anchor="middle">Layer 0 (input)</text>
      <!-- Diverse bars representing feature values per vertex -->
      <text x="30" y="82" font-family="Source Sans 3" font-size="8" fill="#6b6560">vertex features:</text>
      <rect x="30" y="88" width="90" height="6" rx="2" fill="#e8a88a" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="30" y="88" width="82" height="6" rx="2" fill="#b44a2f"/>
      <rect x="30" y="98" width="90" height="6" rx="2" fill="#e8a88a" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="30" y="98" width="15" height="6" rx="2" fill="#b44a2f"/>
      <rect x="30" y="108" width="90" height="6" rx="2" fill="#e8a88a" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="30" y="108" width="68" height="6" rx="2" fill="#b44a2f"/>
      <rect x="30" y="118" width="90" height="6" rx="2" fill="#e8a88a" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="30" y="118" width="42" height="6" rx="2" fill="#b44a2f"/>
      <rect x="30" y="128" width="90" height="6" rx="2" fill="#e8a88a" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="30" y="128" width="76" height="6" rx="2" fill="#b44a2f"/>
      <rect x="30" y="138" width="90" height="6" rx="2" fill="#e8a88a" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="30" y="138" width="22" height="6" rx="2" fill="#b44a2f"/>
      <rect x="30" y="148" width="90" height="6" rx="2" fill="#e8a88a" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="30" y="148" width="55" height="6" rx="2" fill="#b44a2f"/>
      <rect x="30" y="158" width="90" height="6" rx="2" fill="#e8a88a" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="30" y="158" width="88" height="6" rx="2" fill="#b44a2f"/>

      <text x="92" y="182" font-family="Source Sans 3" font-size="10" fill="#b44a2f" text-anchor="middle" font-weight="600">High variance</text>
      <text x="92" y="198" font-family="Source Sans 3" font-size="9" fill="#6b6560" text-anchor="middle">Features are diverse</text>

      <!-- Arrow -->
      <text x="178" y="130" font-family="Source Sans 3" font-size="14" fill="#6b6560">→</text>

      <!-- Layer 1 panel -->
      <rect x="190" y="45" width="155" height="165" rx="8" fill="white" stroke="#d5d0c8"/>
      <text x="267" y="65" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#2a6b5a" text-anchor="middle">After Layer 1</text>
      <text x="205" y="82" font-family="Source Sans 3" font-size="8" fill="#6b6560">vertex features:</text>
      <rect x="205" y="88" width="90" height="6" rx="2" fill="#8ec5b6" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="205" y="88" width="62" height="6" rx="2" fill="#2a6b5a"/>
      <rect x="205" y="98" width="90" height="6" rx="2" fill="#8ec5b6" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="205" y="98" width="38" height="6" rx="2" fill="#2a6b5a"/>
      <rect x="205" y="108" width="90" height="6" rx="2" fill="#8ec5b6" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="205" y="108" width="55" height="6" rx="2" fill="#2a6b5a"/>
      <rect x="205" y="118" width="90" height="6" rx="2" fill="#8ec5b6" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="205" y="118" width="46" height="6" rx="2" fill="#2a6b5a"/>
      <rect x="205" y="128" width="90" height="6" rx="2" fill="#8ec5b6" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="205" y="128" width="58" height="6" rx="2" fill="#2a6b5a"/>
      <rect x="205" y="138" width="90" height="6" rx="2" fill="#8ec5b6" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="205" y="138" width="35" height="6" rx="2" fill="#2a6b5a"/>
      <rect x="205" y="148" width="90" height="6" rx="2" fill="#8ec5b6" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="205" y="148" width="50" height="6" rx="2" fill="#2a6b5a"/>
      <rect x="205" y="158" width="90" height="6" rx="2" fill="#8ec5b6" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="205" y="158" width="60" height="6" rx="2" fill="#2a6b5a"/>

      <text x="267" y="182" font-family="Source Sans 3" font-size="10" fill="#2a6b5a" text-anchor="middle" font-weight="600">Reduced variance</text>
      <text x="267" y="198" font-family="Source Sans 3" font-size="9" fill="#6b6560" text-anchor="middle">Local neighborhoods smooth</text>

      <!-- Arrow -->
      <text x="353" y="130" font-family="Source Sans 3" font-size="14" fill="#6b6560">→</text>

      <!-- Layer 2 panel -->
      <rect x="365" y="45" width="155" height="165" rx="8" fill="white" stroke="#d5d0c8"/>
      <text x="442" y="65" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#3a5a8c" text-anchor="middle">After Layer 2</text>
      <text x="380" y="82" font-family="Source Sans 3" font-size="8" fill="#6b6560">vertex features:</text>
      <rect x="380" y="88" width="90" height="6" rx="2" fill="#a8c0e0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="380" y="88" width="52" height="6" rx="2" fill="#3a5a8c"/>
      <rect x="380" y="98" width="90" height="6" rx="2" fill="#a8c0e0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="380" y="98" width="44" height="6" rx="2" fill="#3a5a8c"/>
      <rect x="380" y="108" width="90" height="6" rx="2" fill="#a8c0e0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="380" y="108" width="50" height="6" rx="2" fill="#3a5a8c"/>
      <rect x="380" y="118" width="90" height="6" rx="2" fill="#a8c0e0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="380" y="118" width="47" height="6" rx="2" fill="#3a5a8c"/>
      <rect x="380" y="128" width="90" height="6" rx="2" fill="#a8c0e0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="380" y="128" width="53" height="6" rx="2" fill="#3a5a8c"/>
      <rect x="380" y="138" width="90" height="6" rx="2" fill="#a8c0e0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="380" y="138" width="42" height="6" rx="2" fill="#3a5a8c"/>
      <rect x="380" y="148" width="90" height="6" rx="2" fill="#a8c0e0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="380" y="148" width="48" height="6" rx="2" fill="#3a5a8c"/>
      <rect x="380" y="158" width="90" height="6" rx="2" fill="#a8c0e0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="380" y="158" width="51" height="6" rx="2" fill="#3a5a8c"/>

      <text x="442" y="182" font-family="Source Sans 3" font-size="10" fill="#3a5a8c" text-anchor="middle" font-weight="600">Low variance</text>
      <text x="442" y="198" font-family="Source Sans 3" font-size="9" fill="#6b6560" text-anchor="middle">Cluster-level patterns</text>

      <!-- Arrow -->
      <text x="528" y="130" font-family="Source Sans 3" font-size="14" fill="#6b6560">→</text>

      <!-- Layer 3 panel -->
      <rect x="540" y="45" width="155" height="165" rx="8" fill="white" stroke="#d5d0c8"/>
      <text x="617" y="65" font-family="Source Sans 3" font-size="11" font-weight="700" fill="#8b5a8c" text-anchor="middle">After Layer 3</text>
      <text x="555" y="82" font-family="Source Sans 3" font-size="8" fill="#6b6560">vertex features:</text>
      <rect x="555" y="88" width="90" height="6" rx="2" fill="#c8a8d0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="555" y="88" width="49" height="6" rx="2" fill="#8b5a8c"/>
      <rect x="555" y="98" width="90" height="6" rx="2" fill="#c8a8d0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="555" y="98" width="46" height="6" rx="2" fill="#8b5a8c"/>
      <rect x="555" y="108" width="90" height="6" rx="2" fill="#c8a8d0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="555" y="108" width="48" height="6" rx="2" fill="#8b5a8c"/>
      <rect x="555" y="118" width="90" height="6" rx="2" fill="#c8a8d0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="555" y="118" width="47" height="6" rx="2" fill="#8b5a8c"/>
      <rect x="555" y="128" width="90" height="6" rx="2" fill="#c8a8d0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="555" y="128" width="50" height="6" rx="2" fill="#8b5a8c"/>
      <rect x="555" y="138" width="90" height="6" rx="2" fill="#c8a8d0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="555" y="138" width="45" height="6" rx="2" fill="#8b5a8c"/>
      <rect x="555" y="148" width="90" height="6" rx="2" fill="#c8a8d0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="555" y="148" width="47" height="6" rx="2" fill="#8b5a8c"/>
      <rect x="555" y="158" width="90" height="6" rx="2" fill="#c8a8d0" fill-opacity="0.3" stroke="#d5d0c8" stroke-width="0.5"/>
      <rect x="555" y="158" width="48" height="6" rx="2" fill="#8b5a8c"/>

      <text x="617" y="182" font-family="Source Sans 3" font-size="10" fill="#8b5a8c" text-anchor="middle" font-weight="600">Very low variance</text>
      <text x="617" y="198" font-family="Source Sans 3" font-size="9" fill="#6b6560" text-anchor="middle">Differences washing out</text>

      <!-- Physics connection -->
      <rect x="15" y="225" width="680" height="65" rx="6" fill="#f8f4ee" stroke="#2a6b5a" stroke-width="1"/>
      <text x="30" y="247" font-family="Source Sans 3" font-size="11" fill="#2a2520">&#9883; <tspan font-weight="700">Physics connection:</tspan> this IS heat diffusion. The aggregation $\hat{\mathbf{A}}\mathbf{H}$ diffuses signals across the graph — each layer is</text>
      <text x="30" y="265" font-family="Source Sans 3" font-size="11" fill="#2a2520">one time step. The learnable weights $\mathbf{W}$ choose what to <tspan fill="#2a6b5a" font-weight="600">amplify or suppress</tspan> at each step, but $\hat{\mathbf{A}}$ always smooths.</text>
      <text x="30" y="283" font-family="Source Sans 3" font-size="11" fill="#6b6560">Without $\mathbf{W}$, stacking $k$ layers would give $\hat{\mathbf{A}}^k\mathbf{H}$ — literally the heat kernel at time $k$ on the graph.</text>
    </svg>
    <div class="caption"><strong>Figure 7.5.</strong> Feature smoothing across layers. Each bar shows one vertex's feature value. Layer 0: features are diverse (original signal). Layer 1: local averaging reduces variance within neighborhoods. Layer 2: broader smoothing produces cluster-level patterns. Layer 3: inter-cluster differences begin to erode. The learnable weights $\mathbf{W}$ partially counteract this smoothing by selectively amplifying useful patterns, but the trend toward uniformity is inherent in repeated averaging.</div>
  </div>

  <div class="insight warning">
    <p><strong>The oversmoothing problem:</strong> If we stacked 10 layers on this 32-node graph, every vertex would see the entire graph multiple times over. All representations would converge toward the graph-wide average — vertices in cluster A would become indistinguishable from vertices in cluster B. This is the <strong>oversmoothing</strong> problem, and it's why most practical GCNs use only 2–4 layers. The learnable weights $\mathbf{W}$ can slow the convergence but cannot fully prevent it when the number of layers far exceeds the graph diameter.</p>
  </div>

  <h3>Summary: Small Graph vs. Large Graph</h3>

  <div class="comp-table">
    <table>
      <thead>
        <tr>
          <th>Aspect</th>
          <th>4-node example (&sect;6)</th>
          <th>32-node example (&sect;7)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Graph diameter</td>
          <td>2</td>
          <td>&approx; 7</td>
        </tr>
        <tr>
          <td>Layers to saturate receptive field</td>
          <td>2</td>
          <td>7+</td>
        </tr>
        <tr>
          <td>Layers used</td>
          <td>1</td>
          <td>3</td>
        </tr>
        <tr>
          <td>Coverage after all layers</td>
          <td>100% (global)</td>
          <td>&approx; 50% (still local)</td>
        </tr>
        <tr>
          <td>Feature dimensions</td>
          <td>2 → 3</td>
          <td>1 → 3 → 3 → 1</td>
        </tr>
        <tr>
          <td>Key lesson</td>
          <td>GCN mechanics</td>
          <td>Depth vs. receptive field trade-off</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<hr class="divider">

<section id="sec8">
  <h2><span class="sec-num">08</span>The GCN–Laplacian Connection</h2>

  <p>
    There's a deep connection between the GCN layer and the Laplacian from Chapter 1. The original (unnormalized) adjacency acts as a <strong>diffusion step</strong>, and the GCN normalization is a specific choice of diffusion rate:
  </p>

  <div class="math-block">
    <div class="math-label">GCN as a spectral filter</div>
    $$\hat{\mathbf{A}} = \mathbf{I} - \hat{\mathbf{L}}_0 \qquad \text{where}\qquad \hat{\mathbf{L}}_0 = \mathbf{I} - \tilde{\mathbf{D}}^{-1/2}\tilde{\mathbf{A}}\tilde{\mathbf{D}}^{-1/2}$$
  </div>

  <p>
    So $\hat{\mathbf{A}}\mathbf{H} = (\mathbf{I} - \hat{\mathbf{L}}_0)\mathbf{H} = \mathbf{H} - \hat{\mathbf{L}}_0\mathbf{H}$. This is exactly <strong>one step of heat diffusion</strong>: the output is the input minus a Laplacian-weighted correction. High-frequency components (large eigenvalues of $\hat{\mathbf{L}}_0$) get attenuated more — the GCN layer is a <em>low-pass filter</em>.
  </p>

  <div class="insight key">
    <p><strong>The bridge to TDL:</strong> A GCN layer uses $\hat{\mathbf{A}}$ (derived from the graph Laplacian $\mathbf{L}_0$) to pass messages between vertices along edges. In Chapters 3–5, we'll build boundary operators $\mathbf{B}_{1,2}$, $\mathbf{B}_{2,3}$, ... that connect edges to faces to volumes. The <strong>higher-order message passing</strong> framework replaces $\hat{\mathbf{A}}$ with Hodge Laplacians and incidence matrices, enabling messages to flow between objects of <em>any rank</em> — not just between adjacent vertices. That's the core innovation of topological deep learning.</p>
  </div>
</section>

<div class="footer-nav"><a href="tdl-01-graphs.html"><span class="dir">← Previous</span><span class="title">Graphs as Combinatorial Objects</span></a><a class="next" href="tdl-03-edge-signals.html"><span class="dir">Next →</span><span class="title">Edge Signals & the Discrete Curl</span></a></div>
</main>
<footer><p><a href="tdl-index.html">← Course Home</a> · <a href="../index.html">All Notes</a></p></footer>
<a href="#" class="back-to-top" aria-label="Back to top">&#8593;</a>
<script>
const fill = document.querySelector('.progress-fill');
const main = document.querySelector('main');
function updateProgress() {
  const top = main.getBoundingClientRect().top;
  const height = main.scrollHeight - window.innerHeight;
  const pct = Math.min(100, Math.max(0, (-top / height) * 100));
  fill.style.width = pct + '%';
}
const btn = document.querySelector('.back-to-top');
function updateBtn() {
  btn.classList.toggle('visible', window.scrollY > 600);
}
window.addEventListener('scroll', function() { updateProgress(); updateBtn(); }, { passive: true });
updateProgress();
</script>
</body>
</html>